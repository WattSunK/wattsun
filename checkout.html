<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Checkout - WattSun Solar</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="main.css" rel="stylesheet"/>
<style>
/* --- [same styles as before] --- */
.container {
  max-width: 950px;
  width: 98vw;
  margin: 44px auto 0 auto;
  padding: 38px 24px 30px 24px;
  background: #fff;
  border-radius: 13px;
  box-shadow: 0 4px 20px rgba(247,183,51,0.10), 0 1.5px 9px rgba(0,0,0,0.04);
  box-sizing: border-box;
}
h2 {
  text-align: center;
  margin-bottom: 26px;
  font-size: 2em;
  font-weight: bold;
  color: #b47d08;
}
/* [table, form, button, nav, and responsive styles unchanged from your file] */
.checkout-table th,
.checkout-table td {
  text-align: left;
  padding: 14px 12px;
  border-bottom: 1px solid #f2e2b6;
  font-size: 1em;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}
.checkout-table th {
  background-color: #f9eabb;
  color: #444;
  font-weight: bold;
  text-align: center;
  vertical-align: middle;
}
/* [other styles unchanged, omitted for brevity] */
</style>
</head>
<body>
<header>
<div class="header-bar">
<h1 class="desktop-logo">
<img alt="WattSun Solar Logo" src="assets/logo/Wattsun Solar log2.png" style="width: 60px; object-fit: contain; margin-right: 10px;"/>
  WattSun Solar
</h1>
<div class="logo-container">
<img alt="WattSun Solar Logo" class="site-logo" src="assets/logo/Wattsun Solar log2.png"/>
<span class="brand-name">WattSun Solar</span>
</div>
<button aria-label="Open menu" class="nav-toggle" onclick="toggleNav()">‚ò∞</button>
</div>
<nav id="mainNav">
<a href="index.html">Home</a>
<a href="solutions.html">Solutions</a>
<a href="shop.html">Shop</a>
<a href="financing.html">Financing</a>
<a href="projects.html">Projects</a>
<a href="contact.html">Contact</a>
<!-- Cart Icon START -->
<a aria-label="View shopping cart" class="cart-icon-link" href="cart.html" title="View cart">
<span class="cart-icon">
    üõí
    <span class="cart-count-badge" id="cart-count-badge">0</span>
</span>
</a>
<!-- Cart Icon END -->
</nav>
</header>
<div class="container">
<h2>Checkout</h2>
<div class="table-wrapper">
<table class="checkout-table" id="cartTable">
<thead>
<tr>
<th class="product-col">Product</th>
<th class="desc-col">Description</th>
<th class="compact-col">Price<br/>(KES)</th>
<th class="compact-col">Deposit<br/>(KES)</th>
<th class="compact-col">Qty</th>
<th class="compact-col">Total<br/>(KES)</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="total" id="totalAmount">Total Deposit: KES 0</div>
<form autocomplete="on" class="checkout-form" id="checkoutForm" name="order">
  <label for="fullName">Full Name</label>
  <input id="fullName" name="fullName" placeholder="Your full name" required type="text"/>
  <label for="email">Email Address</label>
  <input id="email" name="email" placeholder="you@example.com" required type="email"/>
  <label for="phone">Phone Number</label>
  <input id="phone" name="phone" placeholder="+254 7XX XXX XXX" required type="tel"/>
  <label for="address">Delivery Address</label>
  <textarea id="address" name="address" placeholder="Enter delivery location" required rows="3"></textarea>
  <div class="checkout-actions">
    <a class="loan-btn secondary" href="shop.html">‚Üê Back to Shop</a>
    <button class="btn" type="submit">Place Order ‚Üí</button>
  </div>
</form>
</div>
<footer>
  ¬© 2025 WattSun Solar Kenya | <div class="footer-contacts"><a href="mailto:info@wattsun.co.ke">info@wattsun.co.ke</a></div>
</footer>
<script>
function toggleNav() {
  var nav = document.getElementById("mainNav");
  nav.classList.toggle("active");
}
window.addEventListener('resize', function() {
    if(window.innerWidth > 800) {
        document.getElementById("mainNav").classList.remove("active");
    }
});

document.addEventListener("DOMContentLoaded", function () {
  // If we've just come from calculator.html, stash the selected kit
  const selectedKit = JSON.parse(localStorage.getItem("wattSunSelectedKit"));
  if (selectedKit) {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    if (!cart.some(item => item.name === selectedKit.kit)) {
      cart.push({
        name: selectedKit.kit,
        price: selectedKit.price,
        deposit: Math.round(selectedKit.price * 0.5),
        quantity: 1,
        description: selectedKit.description || ""
      });
      localStorage.setItem("cart", JSON.stringify(cart));
    }
    localStorage.removeItem("wattSunSelectedKit");
  }

  function formatNumber(num) {
    return Number(num).toLocaleString('en-US');
  }

  // Helper to truncate description for table column
  function truncateDesc(desc) {
    return desc && desc.length > 60 ? desc.substring(0, 57) + '...' : desc;
  }

  function renderCart() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const tbody = document.querySelector("#cartTable tbody");
    tbody.innerHTML = "";
    let totalDeposit = 0;

    cart.forEach(item => {
      // Defensive: ensure all keys are present
      const name = item.name || "";
      const desc = item.description || "";
      const price = Number(item.price) || 0;
      const deposit = Number(item.deposit) || 0;
      const qty = item.quantity ?? item.qty ?? 1;
      const totalPrice = price * qty;
      const totalItemDeposit = deposit * qty;
      totalDeposit += totalItemDeposit;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="product-col">${name}</td>
        <td class="desc-col">${truncateDesc(desc)}</td>
        <td class="compact-col">${formatNumber(price)}</td>
        <td class="compact-col">${formatNumber(deposit)}</td>
        <td class="compact-col">${qty}</td>
        <td class="compact-col">${formatNumber(totalPrice)}</td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById("totalAmount").textContent =
      "Total Deposit: KES " + totalDeposit.toLocaleString();
  }

  renderCart();

  // --- SUBMIT HANDLER ---
  document.getElementById("checkoutForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      let valid = true;
      this.querySelectorAll('input[required], textarea[required]').forEach(input => {
          if (!input.value.trim() || input.value.trim() === "0") {
              input.style.borderColor = "red";
              valid = false;
          } else {
              input.style.borderColor = "";
          }
      });
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      if (cart.length === 0) {
          alert("Your cart is empty.");
          valid = false;
      }
      if (!valid) {
          return false;
      }

      // Prepare order data
      const orderData = {
        fullName: this.fullName.value,
        email: this.email.value,
        phone: this.phone.value,
        address: this.address.value,
        cart: cart
      };

      // Send order to backend
      try {
        const res = await fetch("/api/checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(orderData)
        });
        if (res.ok) {
          sessionStorage.setItem("clearCartOnThankYou", "true");
          sessionStorage.setItem("orderName", this.fullName.value);
          window.location.href = "thankyou.html";
        } else {
          alert("Order failed. Please try again.");
        }
      } catch (err) {
        alert("Order failed. Please try again.");
      }
  });

  // --- CART BADGE LOGIC ---
  function updateCartCountBadge() {
    let count = 0;
    try {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      count = cart.reduce((sum, item) => sum + (item.quantity ?? item.qty ?? 1), 0);
    } catch(e){}
    const badge = document.getElementById('cart-count-badge');
    if (!badge) return;
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }
  updateCartCountBadge();
  window.addEventListener('storage', updateCartCountBadge);

  // --- CLEAR CART ON THANK YOU PAGE (just in case) ---
  if (window.location.pathname.endsWith("thankyou.html") && sessionStorage.getItem("clearCartOnThankYou")) {
      localStorage.removeItem("cart");
      sessionStorage.removeItem("clearCartOnThankYou");
  }
});
</script>
<footer class="mobile-nav">
<a aria-label="Home" href="index.html">üè†</a>
<a aria-label="Account" href="account.html">üë§</a>
<a aria-label="Cart" href="cart.html">üõí<span id="cart-count">2</span></a>
<a aria-label="Menu" href="javascript:void(0);" onclick="document.querySelector('.nav-toggle').click();">‚ò∞</a>
</footer>
</body>
</html>
