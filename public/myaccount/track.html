<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Track Order</title>
  <link rel="stylesheet" href="/main.css"/>
</head>
<body>
  <header class="site-header">
    <a href="/index.html"><img src="/images/logo.png" alt="Wattsun Logo"></a>
    <nav>
      <a href="/shop.html">Shop</a>
      <a href="/myaccount/userdash.html">My Account</a>
      <a href="/cart.html">Cart <span id="cartCount">0</span></a>
    </nav>
  </header>

  <main class="account-section">
    <h2>Track Your Order</h2>
    <form id="trackForm">
      <label>
        Phone:
        <input id="phone" name="phone" required placeholder="+2547xxxxxxx">
      </label>
      <label>
        Status:
        <input id="status" name="status" placeholder="Optional (Pending, Confirmed...)">
      </label>
      <button type="submit">Track</button>
    </form>

    <p id="lockNote" class="muted"></p>
    <div id="trackBox" class="track-box">Enter your phone number to track orders.</div>
  </main>

  <footer class="site-footer">
    <nav class="mobile-nav">
      <a href="/index.html">Home</a>
      <a href="/shop.html">Shop</a>
      <a href="/myaccount/userdash.html">Account</a>
      <a href="/cart.html">Cart <span id="cartCountFooter">0</span></a>
    </nav>
  </footer>

  <script>
    async function runTrack(phone, status) {
      const box = document.getElementById('trackBox');
      box.innerHTML = 'Loading...';
      try {
        const url = new URL('/api/track', window.location.origin);
        url.searchParams.set('phone', phone);
        if (status) url.searchParams.set('status', status);
        const res = await fetch(url);
        const data = await res.json();

        const list = (data && Array.isArray(data.orders)) ? data.orders : [];

        if (!list.length) {
          box.innerHTML='<p>No orders found for this phone'+(status?' and status':'')+'.</p>';
        } else {
          box.innerHTML = list.map(o=>{
            const total = o.totalCents ? (o.totalCents/100).toLocaleString('en-KE',{minimumFractionDigits:2}) : '—';
            const deposit = o.depositCents ? (o.depositCents/100).toLocaleString('en-KE',{minimumFractionDigits:2}) : '—';
            return `
              <p><strong>Order Number:</strong> ${o.orderNumber}</p>
              <p><strong>Status:</strong> ${o.status||'Pending'}</p>
              <p><strong>Created:</strong> ${o.createdAt?new Date(o.createdAt).toLocaleString():'—'}</p>
              <p><strong>Customer:</strong> ${o.fullName||'—'}</p>
              <p><strong>Delivery Address:</strong> ${o.address||'—'}</p>
              <p><strong>Total:</strong> KSh ${total}</p>
              <p><strong>Deposit:</strong> KSh ${deposit}</p>
              <hr>`;
          }).join('');
        }
      } catch (err) {
        console.error(err);
        box.innerHTML='<p style="color:red;">Error loading orders.</p>';
      }
    }

    document.getElementById('trackForm').addEventListener('submit', e=>{
      e.preventDefault();
      const phone = document.getElementById('phone').value.trim();
      const status = document.getElementById('status').value.trim();
      if (phone) runTrack(phone, status);
    });

    // Session integration: prefill phone if logged in
    document.addEventListener('DOMContentLoaded', ()=>{
      try {
        const raw = localStorage.getItem('wattsunUser') || localStorage.getItem('ws_user');
        if (raw) {
          const u = JSON.parse(raw);
          const phone = u?.user?.phone || u?.phone;
          if (phone) {
            document.getElementById('phone').value = phone;
            document.getElementById('phone').readOnly = true;
            document.getElementById('lockNote').textContent = "Tracking locked to your account phone.";
            runTrack(phone, "");
          }
        }
      } catch {}
    });

    // Auto-run if URL params provided
    const params = new URLSearchParams(window.location.search);
    if (params.get('phone') || params.get('order')) {
      runTrack(params.get('phone') || '', params.get('status') || '');
    }
  </script>
</body>
</html>
