<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>WattSun Solar - Home</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="main.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrL3uFOW9vyvyehZ9erjRzMJ6qdNqGd+HEGhj2U1WPR4r6k6V2Q==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

<style>
/* ...your existing styles unchanged... */
    .cta {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-top: 24px;
      margin-bottom: 0;
    }
    .cta h2 {
      margin-bottom: 7px;
      font-size: 1.5em;
    }
    .cta p {
      margin-bottom: 16px;
      margin-top: 0;
      font-size: 1.07em;
    }
    .cta .loan-btn {
      margin: 0 auto;
      min-width: 230px;
      font-size: 1.14em;
      font-weight: bold;
    }
    section {
      margin-bottom: 22px;
      padding-top: 28px;
      padding-bottom: 22px;
    }
    .feature-row, .steps-row {
      margin-bottom: 16px !important;
    }
    .testimonials-list {
      margin-bottom: 10px;
    }
    footer {
      margin-top: 0 !important;
    }
    h2, .centered-section-title {
      margin-top: 0;
    }
    /* ...rest of your original style unchanged... */
</style>
  
</head>
<body class="has-mobile-footer">
<!-- Environment Banner -->
<script>
(async () => {
  let env = "DEV";
  try {
    const res = await fetch("/api/env");
    const data = await res.json();
    env = (data.env || "DEV").toUpperCase();
  } catch {
    env = location.hostname.includes("qa") ? "QA" : "DEV";
  }

  const banner = document.createElement("div");
  banner.style.cssText = `
    background: ${env === "QA" ? "#ffeb3b" : "#4caf50"};
    color: ${env === "QA" ? "#000" : "#fff"};
    text-align: center;
    padding: 6px;
    font-weight: bold;
    font-size: 14px;
  `;
  banner.textContent =
    env === "QA"
      ? "QA Environment - Build v2025.10.23"
      : "DEV Environment - Build v2025.10.23";
  document.body.prepend(banner);
})();
</script>
<!-- End Environment Banner -->

<!-- Login Modal -->
<div id="loginModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.36);justify-content:center;align-items:center;">
  <div style="background:white;padding:32px 28px 22px 28px;max-width:410px;width:90vw;border-radius:10px;box-shadow:0 6px 40px rgba(0,0,0,0.16);">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0 0 12px 0;font-weight:600;">Login</h2>
      <button onclick="closeLogin()" style="background:none;border:none;font-size:2em;line-height:1;color:#999;">×</button>
    </div>
    <form id="loginForm" style="display:flex;flex-direction:column;gap:14px;">
      <input type="email" id="loginEmail" placeholder="Email" required style="padding:10px 12px;font-size:1em;border:1px solid #ddd;border-radius:6px;">
      <input type="password" id="loginPassword" placeholder="Password" required style="padding:10px 12px;font-size:1em;border:1px solid #ddd;border-radius:6px;">
      <button type="submit" style="margin-top:6px;background:#f4a940;color:white;font-weight:bold;border:none;padding:10px 0;border-radius:6px;font-size:1.1em;">LOGIN</button>
    </form>
    <div style="margin-top:10px;font-size:0.98em;text-align:center;">
      Don't have an account? <a href="#" onclick="openSignup();closeLogin();return false;" style="color:#f4a940;">Sign up</a>
    </div>
    <div style="margin-top:8px;font-size:0.98em;text-align:center;">
      <a href="#" onclick="openPasswordReset();closeLogin();return false;" style="color:#888;text-decoration:underline;">Forgot password?</a>
    </div>
    <div id="loginError" style="color:red;text-align:center;margin-top:7px;font-size:0.97em;display:none;"></div>
  </div>
</div>

<!-- Signup Modal -->
<div id="signupModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.36);justify-content:center;align-items:center;">
  <div style="background:white;padding:32px 28px 22px 28px;max-width:410px;width:90vw;border-radius:10px;box-shadow:0 6px 40px rgba(0,0,0,0.16);">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0 0 12px 0;font-weight:600;">Sign Up</h2>
      <button onclick="closeSignup()" style="background:none;border:none;font-size:2em;line-height:1;color:#999;">×</button>
    </div>
    <form id="signupForm" style="display:flex;flex-direction:column;gap:14px;">
      <input type="text" id="signupName" placeholder="Full Name" required style="padding:10px 12px;font-size:1em;border:1px solid #ddd;border-radius:6px;">
      <input type="email" id="signupEmail" placeholder="Email" required style="padding:10px 12px;font-size:1em;border:1px solid #ddd;border-radius:6px;">
<input type="tel" id="signupPhone" placeholder="+254712345678" pattern="^\+\d{10,15}$" required style="padding:10px 12px;font-size:1em;border:1px solid #ddd;border-radius:6px;">

      <input type="password" id="signupPassword" placeholder="Password" required style="padding:10px 12px;font-size:1em;border:1px solid #ddd;border-radius:6px;">
      <button type="submit" style="margin-top:6px;background:#f4a940;color:white;font-weight:bold;border:none;padding:10px 0;border-radius:6px;font-size:1.1em;">SIGN UP</button>
    </form>
    <div style="margin-top:10px;font-size:0.98em;text-align:center;">
      Already have an account? <a href="#" onclick="openLogin();closeSignup();return false;" style="color:#f4a940;">Login</a>
    </div>
    <div id="signupError" style="color:red;text-align:center;margin-top:7px;font-size:0.97em;display:none;"></div>
    <div id="signupSuccess" style="color:green;text-align:center;margin-top:7px;font-size:0.97em;display:none;"></div>
  </div>
</div>

<!-- Password Reset Modal -->
<div id="resetModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.36);justify-content:center;align-items:center;">
  <div style="background:white;padding:32px 28px 22px 28px;max-width:410px;width:90vw;border-radius:10px;box-shadow:0 6px 40px rgba(0,0,0,0.16);">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0 0 12px 0;font-weight:600;">Reset Password</h2>
      <button onclick="closePasswordReset()" style="background:none;border:none;font-size:2em;line-height:1;color:#999;">×</button>
    </div>
    <form id="resetForm" style="display:flex;flex-direction:column;gap:14px;">
      <input type="email" id="resetEmail" placeholder="Enter your email" required style="padding:10px 12px;font-size:1em;border:1px solid #ddd;border-radius:6px;">
      <button type="submit" style="margin-top:6px;background:#f4a940;color:white;font-weight:bold;border:none;padding:10px 0;border-radius:6px;font-size:1.1em;">Send Reset Link</button>
    </form>
    <div id="resetError" style="color:red;text-align:center;margin-top:7px;font-size:0.97em;display:none;"></div>
    <div id="resetSuccess" style="color:green;text-align:center;margin-top:7px;font-size:0.97em;display:none;"></div>
  </div>
</div>

<header>
  <div class="header-bar">
    <h1 class="desktop-logo">
      <a class="logo-link" href="/index.html">
        <img alt="WattSun Solar Logo" src="assets/logo/Wattsun Solar log2.png" style="width: 60px; object-fit: contain; margin-right: 10px;"/>
        <span>WattSun Solar</span>
      </a>
    </h1>
    <div class="logo-container">
      <a class="logo-link" href="/index.html">
        <img alt="WattSun Solar Logo" class="site-logo" src="assets/logo/Wattsun Solar log2.png"/>
        <span class="brand-name">WattSun Solar</span>
      </a>
    </div>
    <div class="header-actions">
      <button onclick="openLogin()" id="loginBtn" style="background:#f4a940;color:white;border:none;padding:7px 18px;border-radius:5px;font-weight:600;font-size:1em;cursor:pointer;">Login</button>
      <span id="loggedInUser" style="display:none;font-size:1em;color:#222;"></span>
      <button id="logoutBtn" style="display:none;background:#f0701a;color:white;border:none;padding:7px 14px;border-radius:5px;font-size:1em;cursor:pointer;">Logout</button>
    </div>
    <button id="menu-toggle" class="menu-toggle" aria-label="Toggle navigation" aria-controls="primary-navigation" aria-expanded="false">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>
    <nav id="primary-navigation" class="nav-links" aria-label="Primary navigation">
    <a href="/index.html" class="nav-link-item active" aria-label="Home" aria-current="page"><i class="fas fa-home" aria-hidden="true"></i><span class="nav-text">Home</span></a>
    <a href="/solutions.html" class="nav-link-item" aria-label="Solutions"><i class="fas fa-lightbulb" aria-hidden="true"></i><span class="nav-text">Solutions</span></a>
    <a href="/shop.html" class="nav-link-item" aria-label="Shop"><i class="fas fa-store" aria-hidden="true"></i><span class="nav-text">Shop</span></a>
    <!-- <a href="/calculators/calculator.html" class="nav-link-item" aria-label="Calculator"><i class="fas fa-solar-panel" aria-hidden="true"></i><span class="nav-text">Calculator</span></a> -->
    <a href="/financing.html" class="nav-link-item" aria-label="Financing"><i class="fas fa-coins" aria-hidden="true"></i><span class="nav-text">Financing</span></a>
    <a href="/projects.html" class="nav-link-item" aria-label="Projects"><i class="fas fa-diagram-project" aria-hidden="true"></i><span class="nav-text">Projects</span></a>
    <!-- <a href="/myaccount/track.html" class="nav-link-item" aria-label="Track Order"><i class="fas fa-truck" aria-hidden="true"></i><span class="nav-text">Track Order</span></a> -->
    <a href="/contact.html" class="nav-link-item" aria-label="Contact"><i class="fas fa-envelope" aria-hidden="true"></i><span class="nav-text">Contact</span></a>
    <a class="nav-link-item cart-icon-link" href="/cart.html" aria-label="View cart" title="View cart"><span class="cart-icon"><i class="fas fa-shopping-cart" aria-hidden="true"></i><span class="nav-text">Cart</span><span id="cart-count-badge" class="cart-count-badge">0</span></span></a>
  </nav>
</header>
<!-- ...rest of your body (unchanged) ... -->
<div class="hero">
<div class="hero-inner">
<h1>Powering Kenya with Clean, Reliable Solar Energy</h1>
<p>Affordable solar solutions for homes, businesses, and off-grid communities across Kenya.</p>
<p>WattSun Solar is dedicated to empowering communities through clean, renewable energy. We provide tailored solar installations, financing solutions, and after-sales support nationwide.</p>
<a class="loan-btn" href="solutions.html">Explore Solutions</a>
</div>
</div>
<section>
<h2 class="centered-section-title">Why Choose WattSun?</h2>
<div class="feature-row">
<div class="feature-box">
<div class="feature-icon">☀️</div>
<div>
<div class="feature-title">100% Solar-Driven</div>
<div class="feature-desc">Clean energy for homes, farms, and businesses.</div>
</div>
</div>
<div class="feature-box">
<div class="feature-icon">💰</div>
<div>
<div class="feature-title">Flexible Financing</div>
<div class="feature-desc">From just 50% deposit. Up to 36 months repayment.</div>
</div>
</div>
<div class="feature-box">
<div class="feature-icon">🛠️</div>
<div>
<div class="feature-title">Pro Installers</div>
<div class="feature-desc">Available across Nairobi, Kisumu, Eldoret, Naivasha.</div>
</div>
</div>
<div class="feature-box">
<div class="feature-icon">🔧</div>
<div>
<div class="feature-title">After-Sales Support</div>
<div class="feature-desc">We maintain, clean, and upgrade your system.</div>
</div>
</div>
</div>
</section>
<section>
<h2 style="text-align:center;">Success Stories</h2>
<div class="testimonials-list">
<div class="testimonial-row">
<img alt="Family Home – Karen" class="testimonial-img" src="/images/family-home-karen.jpg"/>
<div class="testimonial-text">
<p><strong>Family Home – Karen</strong>: 3kW rooftop + battery backup.</p>
</div>
</div>
<div class="testimonial-row">
<img alt="Nairobi Factory" class="testimonial-img" src="/images/nairobi-factory.jpg"/>
<div class="testimonial-text">
<p><strong>Nairobi Factory</strong>: 9kW hybrid inverter system for full-time operations.</p>
</div>
</div>
<div class="testimonial-row">
<img alt="Off-Grid Lodge – Naivasha" class="testimonial-img" src="/images/offgrid-lodge-naivasha.jpg"/>
<div class="testimonial-text">
<p><strong>Off-Grid Lodge – Naivasha</strong>: Complete off-grid system with storage.</p>
</div>
</div>
</div>
</section>
<section>
<h2 class="centered-section-title">How It Works</h2>
<div class="steps-row">
<div class="step-box">
<div class="step-title">1. Choose a System</div>
<div class="step-desc">Select the right package from our shop.</div>
</div>
<div class="step-box">
<div class="step-title">2. Apply for Financing</div>
<div class="step-desc">Pay your deposit and spread the balance.</div>
</div>
<div class="step-box">
<div class="step-title">3. We Install</div>
<div class="step-desc">Certified technicians handle the setup.</div>
</div>
<div class="step-box">
<div class="step-title">4. Start Saving!</div>
<div class="step-desc">Enjoy clean, uninterrupted solar power.</div>
</div>
</div>
</section>
<section class="cta">
<h2>Ready to go solar?</h2>
<p>Estimate your loan &amp; start saving today!</p>
<a class="loan-btn" href="financing.html">Estimate My Loan</a>
</section>
<footer style="margin-top:48px;width:100%;background:linear-gradient(90deg,#f7b733 0%,#fcf6ba 100%);color:#6b5100;text-align:center;font-size:1.05rem;padding:16px 0 6px;letter-spacing:.01em;"><div class="footer-contacts"><a href="mailto:info@wattsun.co.ke" style="color:#6b5100;text-decoration:underline;">info@wattsun.co.ke</a></div><p>&copy; 2025 WattSun Solar. All rights reserved.</p></footer>

<footer class="mobile-footer" aria-label="Mobile navigation">
  <a href="/index.html" class="active"><i class="fas fa-home" aria-hidden="true"></i><span>Home</span></a>
  <a href="/shop.html"><i class="fas fa-store" aria-hidden="true"></i><span>Shop</span></a>
  <a href="/myaccount/myorders.html"><i class="fas fa-user" aria-hidden="true"></i><span>Account</span></a>
</footer>

<script>
    function updateCartCountBadge() {
      let count = 0;
      try {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
      } catch (e) {}

      const badge = document.getElementById('cart-count-badge');
      const mobileCount = document.getElementById('cart-count');
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
      if (mobileCount) {
        mobileCount.textContent = count;
      }
    }
    document.addEventListener('DOMContentLoaded', updateCartCountBadge);
    window.addEventListener('storage', updateCartCountBadge);
</script>

  <script defer src="js/auth.js"></script> <!-- ...latest reference  ... -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const userObj = JSON.parse(localStorage.getItem("wattsunUser") || "null");
    const user = userObj?.user;
    if (user) {
      const label = document.getElementById("loggedInUser");
      const logout = document.getElementById("logoutBtn");
      const login = document.getElementById("loginBtn");
      login.style.display = "none";
      label.style.display = "inline";
      logout.style.display = "inline";
      label.textContent = user.name;
      label.style.cursor = "pointer";
      label.addEventListener("click", () => {
        const target = user.type === "Admin" ? "/dashboard.html#system-status" : "/myaccount/userdash.html";
        console.log("[auth] login success");
            window.location.href = target;
      });
      logout.addEventListener("click", () => {
        localStorage.removeItem("wattsunUser");
        location.reload();
      });
    }
  });
</script>

<!-- Redirect to checkout only AFTER auth truly succeeds (no auth.js changes needed) -->
<script>
(function () {
  function isLoggedIn() {
    try {
      const obj = JSON.parse(localStorage.getItem("wattsunUser") || "null");
      return !!(obj && (obj.user || obj.success));
    } catch (e) { return false; }
  }

  function redirectNow() {
    const sp = new URLSearchParams(location.search);
    const urlNext = sp.get('next');
    const sessNext = sessionStorage.getItem('redirectAfterLogin');
    const localNext = localStorage.getItem("redirectAfterLogin");
    const raw = sessNext || urlNext || localNext;
    const dest = (raw && /^\/[A-Za-z0-9._\-\/?#=&]*$/.test(raw)) ? raw : "/index.html";

    // cleanup (no stickiness)
    try { sessionStorage.removeItem('redirectAfterLogin'); } catch(e){}
    localStorage.removeItem("redirectAfterLogin");
    localStorage.removeItem("checkoutRedirect");

    console.log("[auth] login success");
            window.location.href = dest;
  }

  function startAuthWatch() {
    if (isLoggedIn()) { redirectNow(); return; }

    let ticks = 0, maxTicks = 600;
    const iv = setInterval(() => {
      if (isLoggedIn()) { clearInterval(iv); redirectNow(); }
      else if (++ticks >= maxTicks) clearInterval(iv);
    }, 250);

    const loginModal = document.getElementById("loginModal");
    if (loginModal) {
      loginModal.addEventListener("hidden.bs.modal", () => { if (isLoggedIn()) redirectNow(); });
      const mo = new MutationObserver(() => {
        const hidden = window.getComputedStyle(loginModal).display === "none";
        if (hidden && isLoggedIn()) { mo.disconnect(); redirectNow(); }
      });
      mo.observe(loginModal, { attributes: true, attributeFilter: ["style", "class"] });
    }

    const signupSuccess = document.getElementById("signupSuccess");
    if (signupSuccess) {
      const mos = new MutationObserver(() => {
        const visible = window.getComputedStyle(signupSuccess).display !== "none";
        if (visible && isLoggedIn()) { mos.disconnect(); redirectNow(); }
      });
      mos.observe(signupSuccess, { attributes: true, attributeFilter: ["style", "class"] });
    }
  }

document.addEventListener("DOMContentLoaded", function () {
  const sp = new URLSearchParams(location.search);
  const next = sp.get("next");
  const sessNext = sessionStorage.getItem("redirectAfterLogin");

  // ✅ B) Start the auth watcher if we have either ?next=... or a saved session next
  if (next || sessNext) {
    sessionStorage.setItem("redirectAfterLogin", next || sessNext);
    startAuthWatch();
  }

  // If already logged in and carrying next in session, jump immediately
  if (isLoggedIn() && sessNext) {
    redirectNow();
  }

  const loginForm = document.getElementById("loginForm");
  if (loginForm) loginForm.addEventListener("submit", () => setTimeout(startAuthWatch, 0));
  const signupForm = document.getElementById("signupForm");
  if (signupForm) signupForm.addEventListener("submit", () => setTimeout(startAuthWatch, 0));
});
})();
</script>
<script>
/* Safe fallbacks if auth.js didn't define these globally */
(function () {
  function show(id) { var m = document.getElementById(id); if (m) m.style.display = 'flex'; }
  function hide(id) { var m = document.getElementById(id); if (m) m.style.display = 'none'; }

  if (typeof window.openLogin !== 'function')  window.openLogin  = function () { show('loginModal'); setTimeout(function(){ try{document.getElementById('loginEmail')?.focus();}catch(e){} }, 0); };
  if (typeof window.closeLogin !== 'function') window.closeLogin = function () { hide('loginModal'); };

  if (typeof window.openSignup !== 'function')  window.openSignup  = function () { show('signupModal'); };
  if (typeof window.closeSignup !== 'function') window.closeSignup = function () { hide('signupModal'); };

  if (typeof window.openPasswordReset !== 'function')  window.openPasswordReset  = function () { show('resetModal'); };
  if (typeof window.closePasswordReset !== 'function') window.closePasswordReset = function () { hide('resetModal'); };
})();
</script>

<script>
  // If URL carries ?next=..., remember it for this tab and auto-open login
  document.addEventListener("DOMContentLoaded", function () {
    try {
      const sp = new URLSearchParams(location.search);
      const next = sp.get('next');
      const safeNext = (next && /^\/[A-Za-z0-9._\-\/?#=&]*$/.test(next)) ? next : null;
      if (safeNext) {
        sessionStorage.setItem('redirectAfterLogin', safeNext);
        if (typeof openLogin === 'function') openLogin();
      }
    } catch (e) {}
  });
</script>
<script>
  // Also treat /login.html and /signup.html as modal entry points
  document.addEventListener("DOMContentLoaded", function () {
    try {
      const p = location.pathname.toLowerCase();
      if (p.endsWith("/login.html") && typeof openLogin === "function") openLogin();
      if (p.endsWith("/signup.html") && typeof openSignup === "function") openSignup();
    } catch (e) {}
  });
</script>
  
  <script>
    // Normalize UI characters and footer copyright on load
    document.addEventListener('DOMContentLoaded', function () {
      try {
        document
          .querySelectorAll('button[onclick="closeLogin()"], button[onclick="closeSignup()"]')
          .forEach(function (btn) {
            btn.textContent = '×';
            btn.setAttribute('aria-label', 'Close modal');
          });
        var fp = document.querySelector('footer p');
        if (fp) fp.innerHTML = '&copy; 2025 WattSun Solar. All rights reserved.';
      } catch (e) {}
  });
</script>

  <script src="/js/menu.js?v=2025.10.24" defer></script>
  <script src="main.js?v=20251020"></script>
</body>
</html>

