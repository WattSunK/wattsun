<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>WattSun Solar - Home</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="main.css" rel="stylesheet"/>
<style>
/* ...unchanged styles... */
</style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.36);justify-content:center;align-items:center;">
  <!-- ...unchanged login form... -->
</div>

<!-- Signup Modal -->
<div id="signupModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.36);justify-content:center;align-items:center;">
  <!-- ...unchanged signup form... -->
</div>

<!-- Password Reset Modal -->
<div id="resetModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.36);justify-content:center;align-items:center;">
  <!-- ...unchanged reset form... -->
</div>

<header>
  <div class="header-bar">
    <h1 class="desktop-logo">
      <img alt="WattSun Solar Logo" src="assets/logo/Wattsun Solar log2.png" style="width:60px;object-fit:contain;margin-right:10px;"/>
      WattSun Solar
    </h1>
    <div class="logo-container">
      <img alt="WattSun Solar Logo" class="site-logo" src="assets/logo/Wattsun Solar log2.png"/>
      <span class="brand-name">WattSun Solar</span>
    </div>
    <button onclick="openLogin()" id="loginBtn" style="margin-left:15px;background:#f4a940;color:white;border:none;padding:7px 18px;border-radius:5px;font-weight:600;font-size:1em;cursor:pointer;">Login</button>
    <span id="loggedInUser" style="display:none;margin-left:15px;font-size:1em;color:#222;"></span>
    <button id="logoutBtn" style="display:none;margin-left:8px;background:#f0701a;color:white;border:none;padding:7px 14px;border-radius:5px;font-size:1em;cursor:pointer;">Logout</button>
    <button aria-label="Open menu" class="nav-toggle">â˜°</button>
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="solutions.html">Solutions</a>
    <a href="shop.html">Shop</a>
    <a href="calculators/calculator.html">Calculator</a>
    <a href="financing.html">Financing</a>
    <a href="projects.html">Projects</a>
    <a href="myaccount/track.html">Track Order</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<!-- ...hero, sections, footer unchanged... -->

<script>
  // Responsive nav menu (unchanged)
  document.addEventListener('DOMContentLoaded', function () {
    const navToggle = document.querySelector('.nav-toggle');
    const header = document.querySelector('header');
    const nav = header.querySelector('nav');
    if (navToggle && header) {
      navToggle.addEventListener('click', function (e) {
        e.stopPropagation();
        header.classList.toggle('nav-open');
      });
    }
    document.querySelectorAll('header nav a').forEach(link => {
      link.addEventListener('click', () => header.classList.remove('nav-open'));
    });
    document.body.addEventListener('click', function (e) {
      if (header.classList.contains('nav-open') &&
          !nav.contains(e.target) &&
          !navToggle.contains(e.target)) {
        header.classList.remove('nav-open');
      }
    }, true);
  });

  // Cart badge (unchanged)
  function updateCartCountBadge() {
    let count = 0;
    try {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    } catch (e) {}
    const badge = document.getElementById('cart-count-badge');
    const mobileCount = document.getElementById('cart-count');
    if (badge) {
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    if (mobileCount) mobileCount.textContent = count;
  }
  document.addEventListener('DOMContentLoaded', updateCartCountBadge);
  window.addEventListener('storage', updateCartCountBadge);
</script>

<script defer src="js/auth.js"></script>

<script>
  // Redirect watcher remains, but no extra login handling (auth.js handles UI)
  (function () {
    function isLoggedIn() {
      try {
        const obj = JSON.parse(localStorage.getItem("wattsunUser") || "null");
        return !!(obj && (obj.user || obj.success));
      } catch (e) { return false; }
    }
    function redirectNow() {
      const sp = new URLSearchParams(location.search);
      const urlNext = sp.get('next');
      const sessNext = sessionStorage.getItem('redirectAfterLogin');
      const localNext = localStorage.getItem("redirectAfterLogin");
      const raw = sessNext || urlNext || localNext;
      const dest = (raw && /^\/[A-Za-z0-9._\-\/?#=&]*$/.test(raw)) ? raw : "/index.html";
      try { sessionStorage.removeItem('redirectAfterLogin'); } catch(e){}
      localStorage.removeItem("redirectAfterLogin");
      localStorage.removeItem("checkoutRedirect");
      window.location.href = dest;
    }
    function startAuthWatch() {
      if (isLoggedIn()) { redirectNow(); return; }
      let ticks = 0, maxTicks = 600;
      const iv = setInterval(() => {
        if (isLoggedIn()) { clearInterval(iv); redirectNow(); }
        else if (++ticks >= maxTicks) clearInterval(iv);
      }, 250);
    }
    document.addEventListener("DOMContentLoaded", function () {
      const sp = new URLSearchParams(location.search);
      const next = sp.get("next");
      const sessNext = sessionStorage.getItem("redirectAfterLogin");
      if (next || sessNext) {
        sessionStorage.setItem("redirectAfterLogin", next || sessNext);
        startAuthWatch();
      }
      if (isLoggedIn() && sessNext) redirectNow();
      const loginForm = document.getElementById("loginForm");
      if (loginForm) loginForm.addEventListener("submit", () => setTimeout(startAuthWatch, 0));
      const signupForm = document.getElementById("signupForm");
      if (signupForm) signupForm.addEventListener("submit", () => setTimeout(startAuthWatch, 0));
    });
  })();
</script>

<script>
  // Safe fallbacks if auth.js didn't define globals
  (function () {
    function show(id) { var m = document.getElementById(id); if (m) m.style.display = 'flex'; }
    function hide(id) { var m = document.getElementById(id); if (m) m.style.display = 'none'; }
    if (typeof window.openLogin !== 'function')  window.openLogin  = function () { show('loginModal'); setTimeout(function(){ try{document.getElementById('loginEmail')?.focus();}catch(e){} }, 0); };
    if (typeof window.closeLogin !== 'function') window.closeLogin = function () { hide('loginModal'); };
    if (typeof window.openSignup !== 'function')  window.openSignup  = function () { show('signupModal'); };
    if (typeof window.closeSignup !== 'function') window.closeSignup = function () { hide('signupModal'); };
    if (typeof window.openPasswordReset !== 'function')  window.openPasswordReset  = function () { show('resetModal'); };
    if (typeof window.closePasswordReset !== 'function') window.closePasswordReset = function () { hide('resetModal'); };
  })();
</script>

<script>
  // Auto-open login/signup if direct URL accessed
  document.addEventListener("DOMContentLoaded", function () {
    try {
      const sp = new URLSearchParams(location.search);
      const next = sp.get('next');
      const safeNext = (next && /^\/[A-Za-z0-9._\-\/?#=&]*$/.test(next)) ? next : null;
      if (safeNext) {
        sessionStorage.setItem('redirectAfterLogin', safeNext);
        if (typeof openLogin === 'function') openLogin();
      }
    } catch (e) {}
  });
  document.addEventListener("DOMContentLoaded", function () {
    try {
      const p = location.pathname.toLowerCase();
      if (p.endsWith("/login.html") && typeof openLogin === "function") openLogin();
      if (p.endsWith("/signup.html") && typeof openSignup === "function") openSignup();
    } catch (e) {}
  });
</script>

</body>
</html>
