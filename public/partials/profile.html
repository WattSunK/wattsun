<!-- Profile with Local Tabs (Orders embedded as a panel) -->
<!-- Use the same button styles/active state as Loyalty tabs -->
<nav class="btn-group" role="tablist" aria-label="Account sections" style="display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px;">
  <button class="btn btn--active" role="tab" aria-selected="true" data-tab="profile">Profile</button>
  <button class="btn btn--ghost" role="tab" aria-selected="false" data-tab="orders">Orders</button>
  <button class="btn btn--ghost" role="tab" aria-selected="false" data-tab="addresses">Delivery Addresses</button>
  <button class="btn btn--ghost" role="tab" aria-selected="false" data-tab="payments">Payment Methods</button>
  <button class="btn btn--ghost" role="tab" aria-selected="false" data-tab="emails">Email Settings</button>
  
</nav>

<div class="tabpanels">
  <!-- PROFILE -->
  <section class="tabpanel" role="tabpanel" data-tabpanel="profile">
    <section class="card">
      <div class="card-header">My Account</div>
      <div class="card-body">
        <div class="form-group">
          <label for="pf-name"><strong>Name</strong></label>
          <input id="pf-name" class="input" type="text" placeholder="Your name">
        </div>
        <div class="form-group">
          <label for="pf-email"><strong>Email</strong></label>
          <input id="pf-email" class="input" type="email" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label for="pf-phone"><strong>Phone</strong></label>
          <input id="pf-phone" class="input" type="tel" placeholder="+254...">
        </div>
        <div class="actions">
          <button id="btnSave" class="btn btn-primary" type="button">Save Changes</button>
          <button id="btnCancel" class="btn" type="button">Cancel</button>
          <a class="btn btn-ghost" href="#" onclick="toast && toast('Password flow TBD','info');return false;">Change Password &gt;</a>
        </div>
      </div>
    </section>
  </section>

  <!-- ORDERS (LOCAL) -->
  <section class="tabpanel" role="tabpanel" data-tabpanel="orders" hidden>
    <style>[data-tabpanel="orders"] .ws-title { display:none; }</style>
    <section class="card">
      <div class="card-header">Orders</div>
      <div class="card-body" id="ordersPanelHost">
        <div class="skel skel-row" style="width:60%;margin:6px 0;"></div>
        <div class="skel skel-row" style="width:40%;margin:6px 0;"></div>
        <div class="skel skel-block" style="height:120px;"></div>
      </div>
    </section>
  </section>

  <!-- ADDRESSES -->
  <section class="tabpanel" role="tabpanel" data-tabpanel="addresses" hidden>
    <section class="card">
      <div class="card-header">Delivery Addresses</div>
      <div class="card-body">
        <div id="addrList" class="addresses-row" style="display:flex;gap:10px;flex-wrap:wrap;"></div>
        <div class="vspace-8"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:640px;">
          <input id="addrLabel" class="input" type="text" placeholder="Label (Home, Office)">
          <input id="addrCity"  class="input" type="text" placeholder="City/Town">
          <textarea id="addrText" class="input" placeholder="Full address" style="grid-column:1 / span 2;min-height:70px;"></textarea>
          <label style="display:flex;align-items:center;gap:6px;"><input id="addrDefault" type="checkbox">Default</label>
          <div style="text-align:right;">
            <button id="addrSave" class="btn btn-primary" type="button">Add Address</button>
          </div>
        </div>
      </div>
    </section>
  </section>

  <!-- PAYMENTS -->
  <section class="tabpanel" role="tabpanel" data-tabpanel="payments" hidden>
    <section class="card">
      <div class="card-header">Payment Methods</div>
      <div class="card-body">
        <div id="pmList" class="payments-row" style="display:flex;gap:10px;flex-wrap:wrap;"></div>
        <div class="vspace-8"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:640px;">
          <input id="pmKind" class="input" type="text" placeholder="Kind (Card, M-Pesa)">
          <input id="pmMask" class="input" type="text" placeholder="Mask (**** 1234 / 07**)">
          <input id="pmMeta" class="input" type="text" placeholder="Meta (optional JSON)" style="grid-column:1 / span 2;">
          <label style="display:flex;align-items:center;gap:6px;"><input id="pmDefault" type="checkbox">Default</label>
          <div style="text-align:right;">
            <button id="pmSave" class="btn btn-primary" type="button">Add Method</button>
          </div>
        </div>
      </div>
    </section>
  </section>

  <!-- EMAIL SETTINGS -->
  <section class="tabpanel" role="tabpanel" data-tabpanel="emails" hidden>
    <section class="card">
      <div class="card-header">Email Settings</div>
      <div class="card-body">
        <div style="display:flex;flex-direction:column;gap:8px;max-width:560px;">
          <label style="display:flex;align-items:center;gap:8px;"><input id="emNews" type="checkbox"> Newsletter</label>
          <label style="display:flex;align-items:center;gap:8px;"><input id="emOrders" type="checkbox"> Order updates</label>
          <label style="display:flex;align-items:center;gap:8px;"><input id="emMkt" type="checkbox"> Marketing</label>
          <div style="margin-top:6px;">
            <button id="emSave" class="btn btn-primary" type="button">Save Preferences</button>
          </div>
        </div>
      </div>
    </section>
  </section>
</div>

<script>
  (function(){
    // Match Loyalty tab behavior (btn group with btn--active)
    const tabs   = [...document.querySelectorAll('nav[role="tablist"] .btn[data-tab]')];
    const panels = [...document.querySelectorAll('.tabpanel')];

    function activateLocal(name){
      tabs.forEach(t => {
        const on = t.dataset.tab === name;
        // Toggle active style to match Loyalty tabs
        t.classList.toggle('btn--active', on);
        t.classList.toggle('btn--ghost', !on);
        t.setAttribute('aria-selected', on ? 'true' : 'false');
      });
      panels.forEach(p => p.hidden = (p.dataset.tabpanel !== name));
      const u = new URL(location.href); u.searchParams.set('tab', name); history.replaceState({}, '', u);
      if (name === 'orders') loadOrdersIntoPanel();
    }

    tabs.forEach(btn => {
      const local = btn.dataset.tab;
      btn.addEventListener('click', () => activateLocal(local));
    });

    // Lightweight profile save stub (wire to /api/users/me later)
    const save = document.getElementById('btnSave');
    // Skip stub if server-backed save is enabled (dashboard wires it)
    if (save && !window.__USE_SERVER_PROFILE_SAVE) {
      save.addEventListener('click', async () => {
        save.classList.add('is-loading'); save.disabled = true;
        try {
          await new Promise(r => setTimeout(r, 400));
          toast && toast('Profile saved', 'success'); window.markFormClean?.();
        } catch (e) {
          toast && toast('Could not save profile', 'error');
        } finally {
          save.classList.remove('is-loading'); save.disabled = false;
        }
      });
    }

    // --- Orders panel lazy loader ---
    let ordersLoaded = false;

    async function ensureScript(src) {
      if ([...document.scripts].some(s => s.src.endsWith(src))) return;
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src; s.onload = resolve; s.onerror = reject;
        document.body.appendChild(s);
      });
    }

    async function loadOrdersIntoPanel() {
      if (ordersLoaded) return;
      const host = document.getElementById('ordersPanelHost');
      if (!host) return;

      try {
        const res = await fetch('/myaccount/myorders.html', { credentials:'same-origin' });
        const html = await res.text();
        const doc  = new DOMParser().parseFromString(html, 'text/html');

        const section = doc.querySelector('section.ws-orders') || doc.body;
        host.innerHTML = '';

        // Also bring over the inline <style> rules that myorders.html defines
        // so the filters and table format correctly when embedded.
        const inlineStyles = [...doc.querySelectorAll('style')];
        inlineStyles.forEach(st => {
          const copy = document.createElement('style');
          copy.textContent = st.textContent || '';
          host.appendChild(copy);
        });

        // Bridge ws-* styles to Admin/Loyalty look & tokens
        // 1) Add Admin classes to existing elements
        try {
          const addCls = (sel, ...cls) => section.querySelectorAll(sel).forEach(el => el.classList.add(...cls));
          section.querySelector('.ws-filters')?.classList.add('filters-bar');
          // Important: don't add global .input (it sets width:100% causing stacking)
          addCls('#wsSearchBtn, #wsClearBtn', 'btn');
          addCls('#wsFirst, #wsPrev, #wsNext, #wsLast', 'btn');
          // Ensure inputs are inline-sized
          ['#wsType','#wsFrom','#wsTo','#wsQuery'].forEach(sel => {
            section.querySelectorAll(sel).forEach(el => { el.style.width = 'auto'; el.style.maxWidth = 'unset'; });
          });
        } catch {}

        // 2) Local style overrides to harmonize remaining ws-* visuals
        const bridge = document.createElement('style');
        bridge.textContent = `
          /* Scope to Profile > Orders panel only */
          [data-tabpanel="orders"] .ws-filters { margin: 8px 0 12px; }
          [data-tabpanel="orders"] .ws-filter-left { display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap; flex: 1 1 auto; }
          [data-tabpanel="orders"] .ws-filter-right { min-width:260px; flex: 0 0 260px; }
          [data-tabpanel="orders"] #wsQuery { width: 100%; }
          [data-tabpanel="orders"] .ws-input { height:34px; box-sizing:border-box; padding:6px 10px; border:1px solid var(--ws-border); border-radius:10px; background:#fff; width:auto; max-width:none; }
          [data-tabpanel="orders"] .ws-input:focus { outline:none; border-color:#f59e0b; box-shadow:0 0 0 2px rgba(245,158,11,.2); }
          [data-tabpanel="orders"] .ws-btn { height:34px; appearance:none; border:1px solid var(--ws-border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; box-shadow:var(--shadow-soft); }
          [data-tabpanel="orders"] .ws-btn:hover { border-color: var(--ws-gold); }
          [data-tabpanel="orders"] .ws-btn-yellow { background:#fff; color:inherit; border-color: var(--ws-border); }
          [data-tabpanel="orders"] .ws-btn-outline { background:#fff; }
          /* Remove inner card chrome since parent is already a card */
          [data-tabpanel="orders"] .ws-card { background:transparent; border:0; box-shadow:none; padding:0; }
        `;
        host.appendChild(bridge);

        host.appendChild(section);

        // Ensure /js/myorders.js is present, then init
        if (typeof window.initMyOrders !== 'function') {
          await ensureScript('/js/myorders.js');
        }
        if (typeof window.initMyOrders === 'function') {
          window.initMyOrders();
        }

        ordersLoaded = true;
      } catch (e) {
        host.innerHTML = `
          <div class="banner error">
            Couldnâ€™t load your orders.
            <div class="spacer"></div>
            <button class="btn small" onclick="location.reload()">Retry</button>
          </div>`;
        toast && toast('Failed to load orders', 'error');
        console.error(e);
      }
    }

    // On load, honor ?tab=...; default to profile
    const initial = new URL(location.href).searchParams.get('tab') || 'profile';
    activateLocal(initial);
    if (initial === 'orders') loadOrdersIntoPanel();

    // --- Minimal hydration (localStorage) ---
    function getUserFromStorage(){
      try{
        const raw = localStorage.getItem('wattsunUser') || localStorage.getItem('ws_user');
        if (!raw) return null;
        const o = JSON.parse(raw);
        return o.user ? o.user : o;
      }catch{ return null; }
    }
    function hydrate(u){
      const name  = u?.name  || u?.fullName || '';
      const email = u?.email || '';
      const phone = u?.phone || '';
      const fName  = document.getElementById('pf-name');
      const fEmail = document.getElementById('pf-email');
      const fPhone = document.getElementById('pf-phone');
      if (fName && !fName.value)  fName.value  = name;
      if (fEmail && !fEmail.value) fEmail.value = email;
      if (fPhone && !fPhone.value) fPhone.value = phone;
    }
    const u0 = getUserFromStorage(); if (u0) hydrate(u0);
    window.addEventListener('storage', (e)=>{ if (e.key==='wattsunUser') { const u = getUserFromStorage(); if (u) hydrate(u); }});

    // ---- Helpers (API) ----
    async function jfetch(url, opts){
      const r = await fetch(url, { credentials:'include', headers:{'Content-Type':'application/json'}, ...(opts||{}) });
      const t = await r.text(); let j=null; try{ j = t?JSON.parse(t):null; }catch{}
      if(!r.ok){ const msg = j?.error || j?.message || (r.status+" "+r.statusText); throw new Error(msg); }
      return j;
    }

    // ---- Addresses ----
    async function loadAddresses(){
      try{
        const data = await jfetch('/api/profile/addresses');
        const list = Array.isArray(data.addresses)?data.addresses:[];
        const host = document.getElementById('addrList'); if(!host) return;
        host.innerHTML = list.map(a=>`<div class="card" style="padding:10px;min-width:240px;">
            <div><strong>${a.label||'Address'}</strong> ${a.isDefault?'<span class="muted">(default)</span>':''}</div>
            <div class="muted">${a.city||''}</div>
            <div>${a.address||''}</div>
            <div class="actions" style="margin-top:8px;">
              <button class="btn btn-sm" data-addr-edit="${a.id}">Edit</button>
              <button class="btn btn-sm" data-addr-del="${a.id}">Delete</button>
            </div>
        </div>`).join('') || '<div class="muted">No addresses yet.</div>';
      }catch(e){ toast&&toast('Failed to load addresses','error'); }
    }
    async function saveAddress(id){
      const body = {
        label: document.getElementById('addrLabel')?.value.trim()||'',
        address: document.getElementById('addrText')?.value.trim()||'',
        city: document.getElementById('addrCity')?.value.trim()||'',
        isDefault: !!document.getElementById('addrDefault')?.checked,
      };
      try{
        if(id){ await jfetch('/api/profile/addresses/'+id,{ method:'PUT', body: JSON.stringify(body) }); }
        else{ await jfetch('/api/profile/addresses',{ method:'POST', body: JSON.stringify(body) }); }
        toast&&toast('Address saved','success');
        document.getElementById('addrLabel').value='';
        document.getElementById('addrText').value='';
        document.getElementById('addrCity').value='';
        document.getElementById('addrDefault').checked=false;
        document.getElementById('addrSave').textContent='Add Address';
        document.getElementById('addrSave').removeAttribute('data-edit');
        loadAddresses();
      }catch(e){ toast&&toast(e.message||'Save failed','error'); }
    }
    document.addEventListener('click',(e)=>{
      const del=e.target.closest('[data-addr-del]'); if(del){ const id=del.getAttribute('data-addr-del'); jfetch('/api/profile/addresses/'+id,{method:'DELETE'}).then(()=>{toast&&toast('Deleted','success');loadAddresses();}).catch(err=>toast&&toast(err.message||'Delete failed','error')); }
      const ed =e.target.closest('[data-addr-edit]'); if(ed){ const id=ed.getAttribute('data-addr-edit'); /* quick fetch list and prefill */ (async()=>{ const data=await jfetch('/api/profile/addresses'); const it=(data.addresses||[]).find(x=>String(x.id)===String(id)); if(it){ document.getElementById('addrLabel').value=it.label||''; document.getElementById('addrText').value=it.address||''; document.getElementById('addrCity').value=it.city||''; document.getElementById('addrDefault').checked=!!it.isDefault; const b=document.getElementById('addrSave'); b.textContent='Update Address'; b.setAttribute('data-edit',id);} })().catch(()=>{}); }
    });
    document.getElementById('addrSave')?.addEventListener('click',()=>{ const id=document.getElementById('addrSave')?.getAttribute('data-edit'); saveAddress(id); });

    // ---- Payments ----
    async function loadPayments(){
      try{
        const data = await jfetch('/api/profile/payments');
        const list = Array.isArray(data.methods)?data.methods:[];
        const host = document.getElementById('pmList'); if(!host) return;
        host.innerHTML = list.map(p=>`<div class="card" style="padding:10px;min-width:240px;">
          <div><strong>${p.kind||'Method'}</strong> ${p.isDefault?'<span class="muted">(default)</span>':''}</div>
          <div class="muted">${p.mask||''}</div>
          <div class="actions" style="margin-top:8px;">
            <button class="btn btn-sm" data-pm-edit="${p.id}">Edit</button>
            <button class="btn btn-sm" data-pm-del="${p.id}">Delete</button>
          </div>
        </div>`).join('') || '<div class="muted">No payment methods.</div>';
      }catch(e){ toast&&toast('Failed to load methods','error'); }
    }
    async function savePayment(id){
      let metaObj=null; const metaRaw=document.getElementById('pmMeta')?.value.trim(); if(metaRaw){ try{ metaObj=JSON.parse(metaRaw); }catch{ toast&&toast('Invalid JSON meta','error'); return; } }
      const body={ kind:document.getElementById('pmKind')?.value.trim()||'', mask:document.getElementById('pmMask')?.value.trim()||'', meta:metaObj, isDefault:!!document.getElementById('pmDefault')?.checked };
      try{
        if(id){ await jfetch('/api/profile/payments/'+id,{method:'PUT', body:JSON.stringify(body)});} else { await jfetch('/api/profile/payments',{method:'POST', body:JSON.stringify(body)}); }
        toast&&toast('Payment saved','success');
        document.getElementById('pmKind').value=''; document.getElementById('pmMask').value=''; document.getElementById('pmMeta').value=''; document.getElementById('pmDefault').checked=false; const b=document.getElementById('pmSave'); b.textContent='Add Method'; b.removeAttribute('data-edit'); loadPayments();
      }catch(e){ toast&&toast(e.message||'Save failed','error'); }
    }
    document.getElementById('pmSave')?.addEventListener('click',()=>{ const id=document.getElementById('pmSave')?.getAttribute('data-edit'); savePayment(id); });
    document.addEventListener('click',(e)=>{
      const del=e.target.closest('[data-pm-del]'); if(del){ const id=del.getAttribute('data-pm-del'); jfetch('/api/profile/payments/'+id,{method:'DELETE'}).then(()=>{toast&&toast('Deleted','success');loadPayments();}).catch(err=>toast&&toast(err.message||'Delete failed','error')); }
      const ed =e.target.closest('[data-pm-edit]'); if(ed){ const id=ed.getAttribute('data-pm-edit'); (async()=>{ const data=await jfetch('/api/profile/payments'); const it=(data.methods||[]).find(x=>String(x.id)===String(id)); if(it){ document.getElementById('pmKind').value=it.kind||''; document.getElementById('pmMask').value=it.mask||''; document.getElementById('pmMeta').value=it.meta||''; document.getElementById('pmDefault').checked=!!it.isDefault; const b=document.getElementById('pmSave'); b.textContent='Update Method'; b.setAttribute('data-edit',id);} })().catch(()=>{}); }
    });

    // ---- Email Settings ----
    async function loadEmailPrefs(){ try{ const d=await jfetch('/api/profile/email-settings'); const p=d.prefs||{}; document.getElementById('emNews').checked=!!p.newsletter; document.getElementById('emOrders').checked=!!p.order_updates; document.getElementById('emMkt').checked=!!p.marketing; }catch(e){}}
    async function saveEmailPrefs(){ try{ const body={ newsletter:document.getElementById('emNews').checked, order_updates:document.getElementById('emOrders').checked, marketing:document.getElementById('emMkt').checked }; await jfetch('/api/profile/email-settings',{method:'PUT', body:JSON.stringify(body)}); toast&&toast('Preferences saved','success'); }catch(e){ toast&&toast(e.message||'Save failed','error'); } }
    document.getElementById('emSave')?.addEventListener('click', saveEmailPrefs);

    // Lazy-load data when visiting tabs
    tabs.forEach(btn=>{
      btn.addEventListener('click',()=>{
        if(btn.dataset.tab==='addresses') loadAddresses();
        if(btn.dataset.tab==='payments')  loadPayments();
        if(btn.dataset.tab==='emails')    loadEmailPrefs();
      });
    });
  })();
</script>
