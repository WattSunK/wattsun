<!-- Settings (page header) -->
<section class="card">
  <div class="card-header">Settings</div>
  <div class="card-body">
    <div class="filters-bar settings-toolbar">
      <div class="group">
        <label>Settings</label>
        <span class="help">Admin</span>
      </div>
      <div class="spacer"></div>
      <button id="btnSettingsRefresh" class="btn small">Refresh</button>
    </div>
    <div id="settingsIntro" class="help">
      Configure company info, user management, notifications, integrations, appearance, loyalty program, and system controls.
    </div>
  </div>
</section>

<!-- Tiny utilities (move into /admin/admin.css later) -->
<style>
  /* optional micro-utility for tighter inline rows when needed */
  .form-row { display: flex; align-items: center; gap: .75rem; }
  .form-row > * { flex: 0 0 auto; }
  .form-row .input { flex: 1 1 auto; }

  /* moved out of inline danger styles; migrate to admin.css when convenient */
  .danger-zone .card-header { color: #a30000; }
  .danger-zone .btn-danger { background: #c62828; color: #fff; }
  .danger-zone .btn-danger:hover { filter: brightness(0.95); }

  /* minimal modal helpers if needed (keeps to your existing naming) */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.35); display:none; z-index: 1000; }
  .modal { background: #fff; max-width: 980px; margin: 4rem auto; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
  .modal-header, .modal-footer { padding: 12px 16px; display: flex; align-items: center; gap: 8px; }
  .modal-header { border-bottom: 1px solid #eee; justify-content: space-between; }
  .modal-footer { border-top: 1px solid #eee; justify-content: flex-end; }
  .modal-tabs { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-bottom: 1px solid #f0f0f0; }
  .modal-body { padding: 16px; }
  .modal .spacer { flex: 1; }
  .banner-error { background:#ffecec; color:#b10000; padding:6px 10px; border-radius:6px; font-size: 12px; }

/* ---- Loyalty modal responsive + golden ring (add this) ---- */
#lsModal .modal { width:100%; max-width:720px; margin:4rem auto; }
@media (max-width:640px){
  #lsModal .modal{max-width:100%; margin:2rem 8px;}
  #lsModal .form-row{display:block;}
  #lsModal .form-row > *{width:100%!important;}
}

/* Golden ring on active tab */
.btn--tab{position:relative; border-radius:10px;}
.btn--tab.is-active{box-shadow:0 0 0 3px #DAA520; outline:none;}
.btn--tab:focus-visible{box-shadow:0 0 0 3px #DAA52088;}
/* Checkbox grid control (replaces <select multiple>) */
.checklist {
  border: 1px solid var(--border, #e6e6e6);
  border-radius: 8px;
  background: #fff;
  padding: 10px 12px;
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px 16px;
  max-height: 180px;        /* keeps it compact like other controls */
  overflow: auto;
}
@media (max-width: 640px) {
  .checklist { grid-template-columns: 1fr; }
}
.checklist .item {
  display: flex;
  align-items: center;
  gap: 8px;
  line-height: 1.25;
}
.checklist .item input[type="checkbox"] {
  width: 16px; height: 16px; margin: 0;
}

</style>

<!-- Settings grid -->
<div class="dash-cards">

  <!-- Company Information -->
  <section class="card">
    <div class="card-header">Company Information</div>
    <div class="card-body">
      <form id="companyInfoForm">
        <div class="form-group">
          <label for="companyName"><strong>Company Name</strong></label>
          <input id="companyName" type="text" class="input" value="WattSun Solar" />
        </div>
        <div class="form-group">
          <label for="supportEmail"><strong>Support Email</strong></label>
          <input id="supportEmail" type="email" class="input" value="support@wattsun.co.ke" />
        </div>
        <div class="form-group">
          <label for="supportPhone"><strong>Support Phone</strong></label>
          <input id="supportPhone" type="tel" class="input" value="+254700123456" />
        </div>
        <div class="form-group">
          <label for="physicalAddress"><strong>Physical Address</strong></label>
          <input id="physicalAddress" type="text" class="input" value="Nairobi, Kenya" />
        </div>
        <div class="actions">
          <button type="button" class="btn" id="btnSaveCompany">Save</button>
        </div>
      </form>
    </div>
  </section>

  <!-- User Management -->
  <section class="card">
    <div class="card-header">User Management</div>
    <div class="card-body">
      <form id="userMgmtForm">
        <div class="form-group">
          <label class="form-row">
            <input id="enforceStrongPasswords" type="checkbox" checked />
            Enforce strong passwords
          </label>
        </div>

        <div class="form-group">
          <label for="sessionTimeout"><strong>Session Timeout</strong></label>
          <select id="sessionTimeout" class="input">
            <option value="5m">5 minutes</option>
            <option value="15m">15 minutes</option>
            <option value="30m">30 minutes</option>
            <option value="1h" selected>1 hour</option>
            <option value="4h">4 hours</option>
            <option value="8h">8 hours</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-row">
            <input id="allowPasswordReset" type="checkbox" checked />
            Allow Password Reset
          </label>
        </div>

        <div class="actions">
          <button type="button" class="btn" id="btnSaveUserMgmt">Save</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Notifications -->
  <section class="card">
    <div class="card-header">Notifications</div>
    <div class="card-body">
      <form id="notificationsForm">
        <div class="form-group">
          <label class="form-row"><input id="notifyOrderPlaced" type="checkbox" checked /> Order Placed Email</label>
        </div>
        <div class="form-group">
          <label class="form-row"><input id="notifyOrderDelivered" type="checkbox" checked /> Order Delivered Email</label>
        </div>
        <div class="form-group form-row">
          <label for="lowStockThreshold"><strong>Low Stock Alerts</strong></label>
          <input id="lowStockThreshold" type="number" min="0" step="1" class="input" style="max-width: 140px;" value="10" />
          <span class="help">threshold</span>
        </div>
        <div class="form-group">
          <label for="alertsEmail"><strong>Send notifications to</strong></label>
          <input id="alertsEmail" type="email" class="input" value="alerts@wattsun.co.ke" />
        </div>
        <div class="actions">
          <button type="button" class="btn" id="btnSaveNotifications">Save</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Integrations -->
  <section class="card">
    <div class="card-header">Integrations</div>
    <div class="card-body">
      <form id="integrationsForm">
        <div class="form-group">
          <label for="paybillNumber"><strong>Paybill Number</strong></label>
          <input id="paybillNumber" type="text" class="input" value="123456" />
        </div>
        <div class="form-group">
          <label for="apiKey"><strong>API Key</strong></label>
          <input id="apiKey" type="password" class="input" value="••••••••••" />
        </div>
        <div class="form-group">
          <label for="smsGateway"><strong>SMS Gateway</strong></label>
          <select id="smsGateway" class="input">
            <option>Africa's Talking</option>
            <option>Twilio</option>
            <option>Infobip</option>
          </select>
        </div>
        <div class="form-group">
          <label for="smsSenderId"><strong>Sender ID</strong></label>
          <input id="smsSenderId" type="text" class="input" value="WattSun" />
        </div>
        <div class="actions">
          <button type="button" class="btn" id="btnSaveIntegrations">Save</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Appearance -->
  <section class="card">
    <div class="card-header">Appearance</div>
    <div class="card-body">
      <form id="appearanceForm">
        <div class="form-group form-row">
          <label for="logoUpload"><strong>Logo Upload</strong></label>
          <input id="logoUpload" type="file" />
        </div>
        <div class="form-group">
          <label for="theme"><strong>Theme</strong></label>
          <select id="theme" class="input">
            <option>Light</option>
            <option>Dark</option>
          </select>
        </div>
        <div class="actions">
          <button type="button" class="btn" id="btnSaveAppearance">Save</button>
        </div>
      </form>
    </div>
  </section>

  <!-- ✅ Loyalty Program (global settings only) -->
<section class="card" id="card-loyalty-program">
  <div class="card-header">Loyalty Program</div>
  <div class="card-body">
    <form id="loyalty-settings-form">

      <!-- Program (global) -->
      <div class="form-group">
        <label for="eligibleUserTypesBox"><strong>Eligible user types</strong></label>
        <div id="eligibleUserTypesBox" class="checklist" aria-describedby="eligibleHelp"></div>
        <div id="eligibleHelp" class="help">Select one or more types.</div>

      </div>

      <div class="form-group">
        <label for="programActive"><strong>Program active</strong></label>
        <select id="programActive" class="input">
          <option value="true">Active</option>
          <option value="false">Paused</option>
        </select>
        <div class="help">If inactive, new enrollments are blocked.</div>
      </div>

      <div class="form-group">
        <label for="digestDay"><strong>Weekly Digest Day</strong></label>
        <select id="digestDay" class="input">
          <option>Mon</option><option>Tue</option><option>Wed</option>
          <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
        </select>
      </div>

      <div class="form-group">
        <label for="referralBonus"><strong>Referral Bonus (points)</strong></label>
        <input id="referralBonus" type="number" min="0" step="1" class="input" />
      </div>

      <!-- Accounts (global) -->
      <hr class="divider" />
      <div class="form-group">
        <label><strong>Accounts</strong></label>
        <div class="help">
          Manage individual accounts (status, balances) in <em>Advanced…</em>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn">Save</button>
        <button type="button" class="btn small" id="openSettings">Advanced…</button>
        <span id="loyalty-settings-status" class="help"></span>
      </div>
    </form>
  </div>
</section>


  <!-- System Controls -->
  <section class="card">
    <div class="card-header">System Controls</div>
    <div class="card-body">
      <form id="systemControlsForm">
        <div class="form-group">
          <button type="button" class="btn" id="btnBackup">Backup Data</button>
        </div>
        <div class="form-group form-row">
          <label for="restoreFile"><strong>Restore from Backup</strong></label>
          <input id="restoreFile" type="file" />
        </div>
        <div class="form-group">
          <button type="button" class="btn" id="btnExport">Export Data</button>
        </div>
        <div class="form-group">
          <button type="button" class="btn" id="btnClearCache">Clear Server Cache</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Danger Zone -->
  <section class="card danger-zone">
    <div class="card-header">Danger Zone</div>
    <div class="card-body">
      <div class="help">Proceed with caution. These actions are irreversible.</div>
      <div class="actions">
        <button type="button" class="btn btn-danger" id="btnResetEmails">Reset Email Settings</button>
        <button type="button" class="btn btn-danger" id="btnDeleteTestData">Delete ALL Test Data</button>
      </div>
    </div>
  </section>

</div><!-- /dash-cards -->

<!-- Page script (only minimal wiring for demo actions; real save hooks can be added later) -->
<script>
  (function () {
    function toast(msg, type){
      try {
        if (typeof window.toast === 'function') return window.toast(msg, type || 'info');
      } catch (_) {}
      console.log('[settings]', msg);
    }
    function confirmDo(msg, fn) { if (confirm(msg)) fn(); }

    // Generic header refresh
    document.getElementById('btnSettingsRefresh')?.addEventListener('click', () => {
      const active = document.querySelector('.admin-nav .nav-link.is-active');
      const id  = active?.getAttribute('data-partial') || 'settings';
      const url = active?.getAttribute('data-url') || '/partials/settings.html';
      if (window.AdminSkin && typeof window.AdminSkin.loadPartial === 'function') {
        window.AdminSkin.loadPartial(id, url);
      } else {
        location.reload();
      }
    });

    // Company Info — hydrate from server and save
    (async function initCompany(){
      try {
        const res = await fetch('/api/admin/company', { credentials: 'include' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const j = await res.json();
        const c = j.company || {};
        const s = (id, v) => { const el = document.getElementById(id); if (el && v != null) el.value = String(v); };
        s('companyName', c.companyName);
        s('supportEmail', c.supportEmail);
        s('supportPhone', c.supportPhone);
        s('physicalAddress', c.physicalAddress);
      } catch (e) { console.warn('[settings] load company:', e.message); }
    })();

    document.getElementById('btnSaveCompany')?.addEventListener('click', async () => {
      try {
        const payload = {
          companyName: document.getElementById('companyName')?.value?.trim() || '',
          supportEmail: document.getElementById('supportEmail')?.value?.trim() || '',
          supportPhone: document.getElementById('supportPhone')?.value?.trim() || '',
          physicalAddress: document.getElementById('physicalAddress')?.value?.trim() || ''
        };
        if (payload.supportEmail && !payload.supportEmail.includes('@')) {
          toast('Please enter a valid Support Email.','error');
          return;
        }
        const res = await fetch('/api/admin/company', {
          method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        toast('Company info saved.','success');
      } catch (e) {
        toast('Save failed: ' + (e.message || e), 'error');
      }
    });

    // User Mgmt — hydrate and save
    (async function initSecurity(){
      try {
        const res = await fetch('/api/admin/security', { credentials: 'include' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const s = data.security || {};
        const elStrong = document.getElementById('enforceStrongPasswords');
        const elAllow  = document.getElementById('allowPasswordReset');
        const elTO     = document.getElementById('sessionTimeout');
        if (elStrong) elStrong.checked = !!s.enforceStrongPasswords;
        if (elAllow)  elAllow.checked  = !!s.allowPasswordReset;
        if (elTO) {
          const mins = Number(s.sessionTimeoutMinutes || 5);
          const map = new Map([
            ['5m', 5], ['15m', 15], ['30m', 30], ['1h', 60], ['4h', 240], ['8h', 480]
          ]);
          // Find matching option; if missing, inject it
          let val = '5m';
          for (const [k,v] of map.entries()) { if (v === mins) { val = k; break; } }
          if (![...map.keys()].includes(val)) {
            const opt = document.createElement('option'); opt.value = `${mins}m`; opt.textContent = `${mins} minutes`; elTO.appendChild(opt); val = `${mins}m`;
          }
          elTO.value = val;
        }
      } catch (e) { console.warn('[settings] load security:', e.message); }
    })();

    document.getElementById('btnSaveUserMgmt')?.addEventListener('click', async () => {
      try {
        const strong = !!document.getElementById('enforceStrongPasswords')?.checked;
        const allow  = !!document.getElementById('allowPasswordReset')?.checked;
        const sel    = document.getElementById('sessionTimeout');
        let mins = 5;
        if (sel) {
          const v = String(sel.value || '5m');
          const map = { '5m':5,'15m':15,'30m':30,'1h':60,'4h':240,'8h':480 };
          mins = map[v] ?? 5;
        }

        const res = await fetch('/api/admin/security', {
          method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ enforceStrongPasswords: strong, allowPasswordReset: allow, sessionTimeoutMinutes: mins })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        toast('User management saved.','success');
      } catch (e) {
        toast('Save failed: ' + (e.message || e),'error');
      }
    });

    // Notifications: hydrate + save via /api/admin/settings
    (async function initNotifications(){
      try {
        const res = await fetch('/api/admin/settings', { credentials: 'include' });
        const data = await res.json();
        const s = data.settings || {};
        const elPlaced = document.getElementById('notifyOrderPlaced');
        const elDelivered = document.getElementById('notifyOrderDelivered');
        const elThresh = document.getElementById('lowStockThreshold');
        const elAlerts = document.getElementById('alertsEmail');
        if (elPlaced) elPlaced.checked = !!s.notifyOrderPlaced;
        if (elDelivered) elDelivered.checked = !!s.notifyOrderDelivered;
        if (elThresh && Number.isFinite(Number(s.lowStockThreshold))) elThresh.value = String(s.lowStockThreshold);
        if (elAlerts && s.alertsEmail != null) elAlerts.value = s.alertsEmail;
      } catch (e) { console.warn('[settings] load notifications:', e.message); }
    })();

    document.getElementById('btnSaveNotifications')?.addEventListener('click', async () => {
      try {
        const payload = {
          notifyOrderPlaced: !!document.getElementById('notifyOrderPlaced')?.checked,
          notifyOrderDelivered: !!document.getElementById('notifyOrderDelivered')?.checked,
          lowStockThreshold: Number(document.getElementById('lowStockThreshold')?.value || 0),
          alertsEmail: String(document.getElementById('alertsEmail')?.value || '').trim(),
        };
        const res = await fetch('/api/admin/settings', {
          method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        toast('Notifications saved.','success');
      } catch (e) {
        toast('Save failed: ' + (e.message || e), 'error');
      }
    });

    // Integrations
    document.getElementById('btnSaveIntegrations')?.addEventListener('click', () => toast('Integrations saved.','success'));

    // Appearance
    document.getElementById('btnSaveAppearance')?.addEventListener('click', () => toast('Appearance saved.','success'));

    // System Controls
    document.getElementById('btnBackup')?.addEventListener('click', () => alert('Backup started.'));
    document.getElementById('restoreFile')?.addEventListener('change', (e) => {
      if (e.target.files?.length) alert('Restore uploaded: ' + e.target.files[0].name);
    });
    document.getElementById('btnExport')?.addEventListener('click', () => alert('Export started.'));
    document.getElementById('btnClearCache')?.addEventListener('click', () =>
      confirmDo('Clear server cache now?', () => console.log('[settings] clear cache'))
    );

    // Danger Zone
    document.getElementById('btnResetEmails')?.addEventListener('click', () =>
      confirmDo('Reset email settings?', () => console.log('[settings] reset SMTP'))
    );
    document.getElementById('btnDeleteTestData')?.addEventListener('click', () =>
      confirmDo('Delete ALL test data? This cannot be undone.', () => console.log('[settings] delete test data'))
    );

    // Open advanced modal
    document.getElementById('openSettings')?.addEventListener('click', () => {
      const overlay = document.getElementById('lsModal');
      if (overlay) overlay.style.display = 'block';
    });
  })();
</script>

<!-- Loyalty — Settings & Accounts Modal (matches your standalone version/screenshot) -->
<div id="lsModal" class="modal-overlay" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lsTitle">
    <div class="modal-header">
      <h3 id="lsTitle">Loyalty — Settings &amp; Accounts</h3>
      <div class="modal-actions">
        <button class="btn small" id="lsClose">Close</button>
        <button class="btn" id="lsSave">Save</button>
      </div>
    </div>

    <div class="modal-tabs">
  <button class="btn btn--tab" id="tabProgramBtn">Program</button>
  <button class="btn btn--tab btn--ghost" id="tabAccountsBtn">Accounts</button>
  <div class="spacer"></div>
  <span id="lsError" class="banner-error" style="display:none;">Error: Admin access required.</span>
</div>

    <div class="modal-body">
      <!-- Program tab -->
      <div id="tabProgram">
       
        <div class="form-group">
          <label for="durationMonths"><strong>Enrollment duration (months)</strong></label>
          <input id="durationMonths" type="number" min="0" step="1" class="input" value="6" />
          <div class="help">Default: 6 months.</div>
        </div>

        <div class="form-group">
          <label for="withdrawWaitDays"><strong>Withdraw wait (days)</strong></label>
          <input id="withdrawWaitDays" type="number" min="0" step="1" class="input" value="90" />
          <div class="help">Days before member can withdraw (default: 90).</div>
        </div>

        <div class="form-group">
          <label for="minWithdrawPoints"><strong>Min withdrawal (points)</strong></label>
          <input id="minWithdrawPoints" type="number" min="0" step="1" class="input" value="100" />
          <div class="help">Minimum per request (default: 100).</div>
        </div>

        <div class="form-group">
          <label for="eurPerPoint"><strong>Euro per point</strong></label>
          <input id="eurPerPoint" type="number" min="0" step="0.0001" class="input" value="1" />
          <div class="help">Conversion rate (default: €1.00 per point).</div>
        </div>

        <div class="form-group">
          <label for="signupBonus"><strong>Signup bonus (points)</strong></label>
          <input id="signupBonus" type="number" min="0" step="1" class="input" value="100" />
          <div class="help">One-time bonus on enrollment (default: 100).</div>
        </div>
        
      </div>

      <!-- Accounts tab -->
      <div id="tabAccounts" style="display:none">
        <div class="form-group form-row">
          <label for="accIdInput"><strong>Account ID</strong></label>
          <input id="accIdInput" class="input" style="max-width:180px" />
          <button class="btn" id="accLoadBtn">Load</button>
        </div>
        <div id="accMsg" class="help"></div>

        <div id="accPanel" style="display:none">
          <div class="form-group"><strong>ID:</strong> <span id="accFieldId"></span></div>
          <div class="form-group"><strong>User ID:</strong> <span id="accFieldUserId"></span></div>
          <div class="form-group">
            <label for="accStatus"><strong>Status</strong></label>
            <select id="accStatus" class="input">
              <option>Active</option>
              <option>Suspended</option>
              <option>Closed</option>
            </select>
          </div>
          <div class="form-group"><strong>Balance:</strong> <span id="accFieldBalance"></span></div>
          <div class="form-group"><strong>Start:</strong> <span id="accFieldStart"></span></div>
          <div class="form-group"><strong>Eligible From:</strong> <span id="accFieldEligible"></span></div>
          <div class="form-group"><strong>End:</strong> <span id="accFieldEnd"></span></div>
          <div class="actions">
            <button class="btn" id="accUpdateBtn">Update Status</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <span id="lsMsg" class="help"></span>
    </div>
  </div>
</div>

<!-- modal controller (your uploaded file; uses event delegation and the IDs above) -->
<script src="/admin/js/settings-loyalty.js?v=20250923"></script>
<script src="/admin/js/admin-loyalty-settings-modal.js?v=20250923"></script>
