<!-- public/partials/admin-loyalty.html -->
<section aria-labelledby="loyalty-title" class="card" id="loyalty-root">
<header class="card-header">
<h2 class="card-title" id="loyalty-title">Loyalty Program</h2>
<div class="spacer"></div>
<div class="btn-group" role="group">
<button class="btn" id="tabWithdrawalsBtn">Withdrawals</button>
<button class="btn btn--ghost" id="tabAccountsBtn">Accounts</button>
<button class="btn btn--ghost" id="tabLedgerBtn">Ledger</button>
<button class="btn btn--ghost" id="tabNotifsBtn">Notifications</button>
</div>
</header>
<div class="card-body">
<!-- Filters -->
<form autocomplete="off" class="filters-bar" id="loyalty-filters">
<!-- Withdrawals Filter -->
<div class="group" id="filterWithdrawals">
<label for="statusSel">Status</label>
<select id="statusSel" name="status">
<option value="">All</option>
<option value="Pending">Pending</option>
<option value="Approved">Approved</option>
<option value="Rejected">Rejected</option>
<option value="Paid">Paid</option>
</select>
</div>
<!-- Accounts Filter -->
<div class="group" id="filterAccounts" style="display:none;">
<label for="accStatusSel">Status</label>
<select id="accStatusSel" name="accStatus">
<option value="">All</option>
<option value="Active">Active</option>
<option value="Closed">Closed</option>
<option value="Suspended">Suspended</option>
</select>
</div>
<!-- Ledger Filter -->
<div class="group" id="filterLedger" style="display:none;">
<label for="ledgerKindSel">Kind</label>
<select id="ledgerKindSel" name="kind">
<option value="">All</option>
<option value="Earn">Earn</option>
<option value="Penalty">Penalty</option>
<option value="Withdraw">Withdraw</option>
<option value="Deposit">Deposit</option>
</select>
</div>
<!-- Notifications Filter -->
<div class="group" id="filterNotifs" style="display:none;">
<label for="notifStatusSel">Status</label>
<select id="notifStatusSel" name="notifStatus">
<option value="">All</option>
<option value="Sent">Sent</option>
<option value="Failed">Failed</option>
<option value="Pending">Pending</option>
</select>
</div>
<!-- Search + buttons (always visible, aligned right) -->
<div class="group" style="margin-left:auto; display:flex; align-items:flex-end; gap:0.5rem;">
<div>
<label for="loyaltySearch">Search</label>
<input class="input" id="loyaltySearch" name="q" placeholder="Find record…"/>
</div>
<button class="btn" id="loyaltyClearBtn" type="button">Clear</button>
<button class="btn" id="loyaltyRefreshBtn" type="button">Refresh</button>
<button class="btn" id="wdNewBtn" type="button">New Withdrawal</button>
<button class="btn" id="accManageBtn" style="display:none;" type="button">Manage</button>
</div>
</form>
<!-- Withdrawals Table -->
<div class="loyalty-tab" id="loyaltyTabWithdrawals">
<table class="table">
<thead>
<tr>
<th>ID</th>
<th>Account</th>
<th>User</th>
<th>Points</th>
<th>Status</th>
<th>Requested</th>
<th>Decided</th>
<th>Paid</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="wdBody">
<tr><td class="muted" colspan="9">(No data yet)</td></tr>
</tbody>
</table>
</div>
<!-- Accounts Table -->
<div class="loyalty-tab" id="loyaltyTabAccounts" style="display:none;">
<table class="table">
<thead>
<tr>
<th>ID</th>
<th>User ID</th>
<th>Email</th>
<th>Status</th>
<th>Start</th>
<th>End</th>
<th>Duration (mo)</th>
<th>Balance</th>
<th>Earned</th>
<th>Penalty</th>
<th>Paid</th>
</tr>
</thead>
<tbody id="loyaltyAccountsBody">
<tr><td class="muted" colspan="11">(No data yet)</td></tr>
</tbody>
</table>
</div>
<!-- Ledger Table -->
<div class="loyalty-tab" id="loyaltyTabLedger" style="display:none;">
<table class="table">
<thead>
<tr>
<th>ID</th>
<th>Account</th>
<th>Kind</th>
<th>Δ Points</th>
<th>Note</th>
<th>When</th>
</tr>
</thead>
<tbody id="loyaltyLedgerBody">
<tr><td class="muted" colspan="6">(No data yet)</td></tr>
</tbody>
</table>
</div>
<!-- Notifications Table -->
<div class="loyalty-tab" id="loyaltyTabNotifs" style="display:none;">
<table class="table">
<thead>
<tr>
<th>ID</th>
<th>Kind</th>
<th>Email</th>
<th>Status</th>
<th>Created</th>
</tr>
</thead>
<tbody id="loyaltyNotificationsBody">
<tr><td class="muted" colspan="5">(No data yet)</td></tr>
</tbody>
</table>
</div>
<!-- Shared Meta Bar + Pagination -->
<footer class="table-meta" style="display:flex; align-items:center; justify-content:space-between;">
<div class="meta" id="loyaltyMeta">0 results</div>
<div class="pager" id="loyaltyPager">
<button class="btn btn--small">First</button>
<button class="btn btn--small">« Prev</button>
<span>1</span>
<button class="btn btn--small">Next »</button>
<button class="btn btn--small">Last</button>
</div>
</footer>
</div>
<style>
  /* Make the dialog wider and use the available height */
  #accManageDialog {
    width: min(100vw, 960px);
    padding: 0;
  }
  /* Form becomes a vertical flex container; the scroll lives inside .modal-body */
  #accManageDialog form {
    max-height: 90vh;
    display: flex;
    flex-direction: column;
  }
  /* Two-column responsive grid for sections */
  #accManageDialog .modal-body {
    display: grid;
    grid-template-columns: 1fr 1fr;      /* 2 columns */
    gap: 16px;
    overflow: auto;                      /* internal scroll if content overflows */
    padding: 12px 16px;
  }
  /* Optional utility: make wide sections span both columns */
  #accManageDialog .span-2 {
    grid-column: 1 / -1;
  }
  /* Normalize section spacing inside grid */
  #accManageDialog .section { margin: 0; }
  #accManageDialog .section .row { margin: 0; }
  /* Sticky footer so buttons remain visible; removes need for page scroll */
  #accManageDialog .modal-actions {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 12px 16px;
    border-top: 1px solid #eee;
    margin-top: 0;
  }
  /* Inputs expand nicely */
  #accManageDialog .input,
  #accManageDialog input[type="date"],
  #accManageDialog input[type="text"],
  #accManageDialog select,
  #accManageDialog textarea {
    width: 100%;
    box-sizing: border-box;
  }
</style>
<!-- Manage dialog (unchanged) -->
<dialog class="modal modal--lg" id="accManageDialog">
<form class="card modal__sheet" method="dialog">
<header class="card-header" style="display:flex;gap:.5rem;align-items:center;justify-content:space-between;">
<h3 class="card-title">Manage Loyalty Account</h3>
  <div class="row" style="gap:.5rem;flex-wrap:wrap;">
    <button id="mCreateBtn" type="button" class="btn btn--primary" style="display:none;">Create Active Account</button>
    <button class="btn" id="mApplyAll" type="button">Apply Changes</button>
    <button class="btn" value="close" type="submit">Close</button>
  </div>
</header>
<div class="card-body modal__body">
<div class="row" style="margin-bottom:10px">
<div class="group" style="flex:1">
<label for="mUserSearch">Search user</label>
<input class="input" id="mUserSearch" placeholder="Search by name, email, or phone" type="text"/>
</div>
<div class="group" style="flex:1">
<label for="mUserResults">Results</label>
<select class="input" id="mUserResults"></select>
</div>

<div id="mHintBlock" class="hint-card" style="margin:12px 0; line-height:1.5;">
  <div><strong>Program:</strong> <span id="mHintProgram">—</span></div>
  <div>Minimum withdrawal = <span id="mHintMin">—</span> points</div>
  <div>Eligible from = <span id="mHintEligible">—</span></div>
  <div>Start = <span id="mHintStart">—</span>, End = <span id="mHintEnd">—</span></div>
</div>

<div class="row row--cols">
<div class="group">
<label for="mAccId"><strong>Account ID</strong></label>
<input class="input" id="mAccId" placeholder="e.g. 1" type="number"/>
</div>
<div class="group">
<label for="mUserId"><strong>User ID</strong></label>
<input class="input" id="mUserId" placeholder="e.g. 42" type="number"/>
</div>
</div>
<div class="section">
<h4 class="section-title">Status</h4>
<div class="row row--cols">
<div class="group">
<label for="mStatus">New status</label>
<select class="input" id="mStatus">
<option value="Active">Active</option>
<option value="Paused">Paused</option>
<option value="Suspended">Suspended</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="section">
  <h4 class="section-title">Extend</h4>
  <div class="row row--cols">
    <div class="group">
      <label for="mExtendDate">Extend Date</label>
      <input class="input" id="mExtendDate" type="date" placeholder="YYYY-MM-DD" />
      <div class="muted" style="margin-top:4px;">
        Pick a new end date for the account.
      </div>
    </div>
  </div>
</div>
<div class="section">
  <h4 class="section-title">Eligibility</h4>
  <div class="row row--cols">
    <div class="group">
      <label for="mEligibleFrom">Eligible From</label>
      <input class="input" id="mEligibleFrom" type="date" placeholder="YYYY-MM-DD" />
      <div class="muted" style="margin-top:4px;">
        Withdrawals are allowed on or after this date.
      </div>
    </div>
  </div>
</div>

</div>
</div>
<div class="section">
<h4 class="section-title">Penalty</h4>
<div class="row row--cols">
<div class="group">
<label for="mPenaltyPoints">Points</label>
<input class="input" id="mPenaltyPoints" min="1" placeholder="e.g. 10" type="number"/>
</div>
<div class="group">
<label for="mPenaltyNote">Reason</label>
<input class="input" id="mPenaltyNote" placeholder="reason for penalty"/>
</div>
</div>
</div>
<div class="section">
<h4 class="section-title">Response</h4>
<pre class="output" id="mOut"></pre>
</div>
</div>
</form>
</dialog>
<!-- New Withdrawal (admin-initiated) -->
<dialog class="modal" id="wdNewDialog">
<form class="card modal__sheet" method="dialog">
<header class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
<h3 class="card-title">New Withdrawal</h3>
<div class="row" style="gap:.5rem;">
<button class="btn" value="close">Close</button>
</div>
</header>
<div class="card-body modal__body">
<!-- Increment 2: user search + results -->
<div class="row" style="margin-bottom:10px">
<div class="group" style="flex:1">
<label for="wdUserSearch">Search user</label>
<input class="input" id="wdUserSearch" placeholder="Search by name, email, or phone" type="text"/>
</div>
<div class="group" style="flex:1">
<label for="wdUserResults">Results</label>
<select class="input" id="wdUserResults"></select>
</div>
</div>
<!-- Program/min/balance hint -->
<div class="muted" id="wdHintBlock" style="margin:12px 0; line-height:1.5;">
<div><strong>Program:</strong> <span id="wdHintProgram">—</span></div>
<div>Minimum withdrawal = <span id="wdHintMin">—</span> points</div>
<div>Balance = <span id="wdHintBal">—</span> points</div>
</div>
<!-- Hidden accountId chosen from search -->
<input id="wdAccountId" type="hidden"/>
<!-- Legacy fallback row (kept, works if search not used) -->
<div class="row row--cols">
<div class="group">
<label for="wdAccId"><strong>Account ID</strong></label>
<input class="input" id="wdAccId" min="1" placeholder="e.g. 12" type="number"/>
</div>
<div class="group">
<label for="wdPoints"><strong>Points</strong></label>
<input class="input" id="wdPoints" min="1" placeholder="e.g. 100" step="1" type="number"/>
</div>
</div>
<!-- Inline validation error -->
<div class="form-error" id="wdError" style="display:none;color:#b00020;margin-top:4px"></div>
<div class="group">
<label for="wdNote"><strong>Note (optional)</strong></label>
<input class="input" id="wdNote" placeholder="context or reference"/>
</div>
<div class="actions" style="margin-top:8px;">
<!-- canonical id for JS; old id kept in JS as fallback -->
<button class="btn" disabled="" id="wdSubmit" type="button">Create</button>
</div>
<pre class="output" id="wdOut"></pre>
</div>
</form>
</dialog>
</section>
