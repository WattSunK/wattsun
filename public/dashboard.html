<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WattSun Admin</title>
  <link href="/admin/admin.css?v=20250912-02" rel="stylesheet" />
</head>
<body class="admin-shell">
  <aside class="admin-sidebar">
    <div class="brand">
      <div class="brand-logo" aria-hidden="true">☀️</div>
      <div class="brand-title">WattSun Admin</div>
    </div>
    <nav class="admin-nav" aria-label="Admin Navigation">
      <a href="#" class="nav-link is-active"
         data-partial="system-status" data-url="/partials/system-status.html">System Status</a>

      <a href="#" class="nav-link"
         data-partial="profile" data-url="/partials/profile.html">Profile</a>

      <a href="#" class="nav-link"
         data-partial="users" data-url="/partials/users.html">Users</a>
    
      <a href="#" class="nav-link"
         data-partial="orders" data-url="/partials/orders.html">Orders</a>
   
      <a href="#" class="nav-link"
         data-partial="items" data-url="/partials/items.html">Items</a>

      <a href="#" class="nav-link"
         data-partial="dispatch" data-url="/partials/dispatch.html">Dispatch</a>

      <a href="#" class="nav-link"
         data-partial="admin-loyalty" data-url="/partials/admin-loyalty.html">Loyalty</a>

       <a href="#" class="nav-link"
         data-partial="settings" data-url="/partials/settings.html">Admin Settings</a>   
      <!-- Existing external link (optional, unchanged) -->
       
      
     

    </nav>
  </aside>

  <main class="admin-main">
    <header class="admin-topbar">
      <h1 class="page-title">Dashboard</h1>
      <div id="headerUser" class="header-user" style="margin-left:auto; margin-right:12px; text-align:right;">
        <div class="user-name" style="font-weight:600;"></div>
        <div class="user-meta" style="font-size:12px; color:#777;"></div>
      </div>
      <div class="topbar-actions">
        <!-- NEW: Home + Logout buttons -->
        <button id="btn-home" class="btn btn-ghost" type="button" title="Go to Home">Home</button>
        <button id="btn-logout" class="btn btn-ghost" type="button" title="Log out">Logout</button>
        <!-- Existing -->
        <button id="hard-refresh" class="btn btn-ghost" type="button" title="Hard refresh">Refresh</button>
      </div>
    </header>

    <section id="admin-content" class="admin-content" aria-live="polite" aria-busy="true">
      <div class="loading">
        <span class="spinner" aria-hidden="true"></span>
        <span class="sr-only">Loading…</span>
      </div>
    </section>
  </main>

  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Add Order modal include -->
  <!--#include file="/public/partials/orders-add.html" -->

  <script>
    window.toast = (msg, type="info", ms=3000) => {
      const box = document.getElementById("toasts");
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.role = "status";
      el.innerText = msg;
      box.appendChild(el);
      requestAnimationFrame(() => el.classList.add("show"));
      setTimeout(() => { el.classList.remove("show"); setTimeout(() => el.remove(), 250); }, ms);
    };
    // Removed custom askConfirm + dialog. Use native window.confirm() in section code when needed.
  </script>

<!-- Wire Home + Logout (Home does NOT log out) -->

<script>
  (function () {
    const homeBtn   = document.getElementById('btn-home');
    const logoutBtn = document.getElementById('btn-logout');

    function goHome(e) {
      e?.preventDefault?.(); e?.stopPropagation?.(); e?.stopImmediatePropagation?.();
      // Do NOT clear session here
      location.replace('/'); // send to site root (where index.html is served)
    }

    function doLogout(e) {
      e?.preventDefault?.(); e?.stopPropagation?.(); e?.stopImmediatePropagation?.();
      try { localStorage.removeItem('wattsunUser'); } catch {}
      location.replace('/'); // then go to site root
    }

    homeBtn?.addEventListener('click', goHome, true);   // capture=true to override other listeners
    logoutBtn?.addEventListener('click', doLogout, true);
  })();
</script>

  <script>window.__ADMIN_VERSION__ = "20250906-02";</script>
  <script>window.__USE_SERVER_PROFILE_SAVE = true;</script>

  <!-- Profile hydration + Save (server-backed) -->
  <script>
    (function(){
      async function fetchMe(){
        try{
          const r = await fetch('/api/users/me', { credentials:'include' });
          if(!r.ok) return null; const j = await r.json(); return j && (j.user || j);
        }catch{ return null; }
      }
      function updateHeader(u){
        const box = document.getElementById('headerUser'); if(!box) return;
        const name = u?.name || u?.fullName || 'User';
        const email = u?.email || '';
        const phone = u?.phone || '';
        const n = box.querySelector('.user-name'); if(n) n.textContent = name;
        const m = box.querySelector('.user-meta'); if(m) m.textContent = [email, phone].filter(Boolean).join(' · ');
      }
      function fillProfileInputs(root,u){
        if(!root || !u) return;
        const fN = root.querySelector('#pf-name'); if(fN) fN.value = u.name || u.fullName || '';
        const fE = root.querySelector('#pf-email'); if(fE) fE.value = u.email || '';
        const fP = root.querySelector('#pf-phone'); if(fP) fP.value = u.phone || '';
      }
      async function attachProfileSave(root){
        const btn = root.querySelector('#btnSave'); if(!btn || btn.dataset.bound) return; btn.dataset.bound = '1';
        btn.addEventListener('click', async ()=>{
          const body = {
            name:  root.querySelector('#pf-name')?.value?.trim() || '',
            email: root.querySelector('#pf-email')?.value?.trim() || '',
            phone: root.querySelector('#pf-phone')?.value?.trim() || ''
          };
          try{
            const r = await fetch('/api/users/me', {
              method:'PUT', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
            });
            const j = await r.json();
            if(!r.ok || j.success===false){ toast && toast(j.error||'Save failed','error'); return; }
            const me = j.user || j; updateHeader(me);
            try{ localStorage.setItem('wattsunUser', JSON.stringify({success:true, user: me})); }catch{}
            toast && toast('Profile saved','success');
          }catch(e){ toast && toast('Network error','error'); }
        });
      }
      async function boot(){
        const me = await fetchMe(); if(me){ updateHeader(me); try{ localStorage.setItem('wattsunUser', JSON.stringify({success:true, user: me})); }catch{} }
      }
      window.addEventListener('admin:partial-loaded', async (e)=>{
        if(e?.detail?.id === 'profile' || e?.detail?.name === 'profile'){
          const me = await fetchMe(); if(me){ fillProfileInputs(document, me); }
          attachProfileSave(document);
        }
      });
      document.addEventListener('DOMContentLoaded', boot);
    })();
  </script>

  <!-- Load order-sensitive scripts in correct order -->
  <script src="/admin/js/admin-skin.js?v=20250918-01"></script>
  <script src="/admin/js/data-adapter.js?v=202509-08" defer></script>
  <script src="/admin/js/orders-controller.js?v=20251005-01" defer></script>
  <script src="/admin/js/dispatch-controller.js?v=20250912-03" defer></script>  
  <script src="/admin/js/orders-edit.js?v=20250915-06" defer></script>
  <script src="/admin/js/orders-add.js?v=20250911-12" defer></script>
  <script src="/admin/js/admin-users.js?v=20250915-02"></script>
 <script src="admin/js/admin-loyalty-settings-modal.js?v=20250911-12"></script>
  <script defer src="/admin/js/admin-loyalty.js?v=20250922-01"></script>
  <script src="./admin/js/loyalty-manage.js?v=1" defer></script>
  <script src="/admin/js/admin-loyalty-approve.js"></script>
  <script src="/admin/js/admin-loyalty-reject.js"></script>
  <script src="/admin/js/admin-loyalty-mark-paid.js"></script>


  </body>
</html>
