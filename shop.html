<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shop - WattSun</title>
  <link rel="stylesheet" href="main.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      padding: 1em;
    }
    .product-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 28px -7px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.2s ease-in-out;
    }
    .product-card:hover {
      transform: scale(1.02);
    }
    .product-card img {
      height: 90px;
      object-fit: contain;
      margin-bottom: 12px;
      background: #f7f2e9;
      border-radius: 12px;
    }
    .cart-count-badge {
      background: #3E9F50 !important;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.7em;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: -0.7em;
      right: -0.7em;
      box-shadow: 0 0 0.13em #0001;
      z-index: 1;
    }
  </style>
</head>
<body>
<header>
  <div class="header-bar" style="background: linear-gradient(90deg, #ffc371 0%, #ffb347 100%); padding: 1em; display: flex; justify-content: space-between; align-items: center;">
    <h1 style="margin: 0; font-size: 1.6em; color: white; display: flex; align-items: center;">
      <img src="assets/logo/Wattsun Solar log2.png" alt="WattSun Solar Logo" style="height: 40px; margin-right: 10px;" />
      WattSun Solar
    </h1>
    <nav style="display: flex; gap: 16px;">
      <a href="index.html">Home</a>
      <a href="solutions.html">Solutions</a>
      <a href="shop.html">Shop</a>
      <a href="financing.html">Financing</a>
      <a href="projects.html">Projects</a>
      <a href="contact.html">Contact</a>
      <a class="cart-icon-link" href="cart.html" style="position: relative;">
        üõí <span class="cart-count-badge">0</span>
      </a>
    </nav>
  </div>
</header>
<main>
  <div id="toast" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#3E9F50; color:white; padding:12px 20px; border-radius:8px; font-size:0.95em; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:9999;">
    Added to cart!
  </div>
  <div id="shop-products" class="grid"></div>
</main>
<footer style="background: linear-gradient(90deg, #f4c14b 0%, #fbe68b 100%); text-align: center; padding: 1em;">
  <a href="mailto:info@wattsun.co.ke">info@wattsun.co.ke</a>
  <p>¬© 2025 WattSun Solar. All rights reserved.</p>
</footer>
<script>
function updateCartCountBadge() {
  let count = 0;
  try {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
  } catch (e) {}
  document.querySelectorAll('.cart-count-badge').forEach(badge => {
    badge.textContent = count;
    badge.style.display = count > 0 ? 'flex' : 'none';
  });
}

function parsePrice(rawPrice) {
  return parseInt((rawPrice || '').replace(/[^\d]/g, '')) || 0;
}

async function loadProducts() {
  const container = document.getElementById("shop-products");
  try {
    const res = await fetch("http://192.168.1.52:3001/api/items");
    let products = await res.json();
    container.innerHTML = "";

    const prioritySKUs = ["SYS-1KW", "SYS-3KW", "SYS-6KW", "SYS-9KW", "INV-5KW", "KIT-CLEAN", "BATT-24V100AH", "PANEL-450W"];
    const priorityItems = [], rest = [];

    products.forEach(p => {
      (prioritySKUs.includes(p.sku) ? priorityItems : rest).push(p);
    });

    const sorted = [...priorityItems, ...rest];

    sorted.forEach((prod, i) => {
      const id = `dep_${i}`;
      const image = prod.image_path ? \`images/categories/\${prod.image_path}\` : "images/placeholder.jpg";
      const price = parsePrice(prod.price);

      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = \`
        <img src="\${image}" alt="\${prod.name}" onerror="this.src='images/placeholder.jpg';" />
        <div class="product-info">
          <h3>\${prod.name}</h3>
          <p>\${prod.description}</p>
          <p>Total Price: KES \${price.toLocaleString()}</p>
        </div>
        <input type="number" id="\${id}" placeholder="Enter your deposit (KES)" />
        <button class="loan-btn" onclick="addToCart('\${prod.sku}', '\${prod.name}', \${price}, '\${id}', '\${prod.description.replace(/'/g, "\'")}')">Add to Cart</button>
      \`;
      container.appendChild(card);
    });

    updateCartCountBadge();
  } catch (err) {
    container.innerHTML = "<p style='color:red;'>Failed to load products. Please try again.</p>";
    console.error("‚ùå Error loading products:", err);
  }
}

function addToCart(sku, name, price, inputId, description) {
  const depositValue = document.getElementById(inputId).value;
  const deposit = Number(depositValue);
  if (!deposit || isNaN(deposit) || deposit <= 0) {
    alert("Please enter a valid deposit amount.");
    return;
  }

  const cart = JSON.parse(localStorage.getItem("cart") || "[]");
  const index = cart.findIndex(item => item.sku === sku);
  if (index >= 0) {
    cart[index].quantity += 1;
    cart[index].deposit = deposit;
  } else {
    cart.push({ sku, name, price, quantity: 1, deposit, description });
  }
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCountBadge();

  const toast = document.getElementById("toast");
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 2500);
}

document.addEventListener("DOMContentLoaded", () => {
  loadProducts();
  updateCartCountBadge();
});
window.addEventListener("storage", updateCartCountBadge);
</script>
</body>
</html>